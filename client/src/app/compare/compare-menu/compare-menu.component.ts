import {
  Component,
  OnInit,
  Output,
  EventEmitter,
  ViewChild,
} from '@angular/core';
import { FormArray, FormControl, FormGroup, Validators } from '@angular/forms';
import { BsModalRef, BsModalService } from 'ngx-bootstrap/modal';
import { ICompareCriteria, IScenario } from 'src/app/shared/models/ICompare';
import { CompareService } from '../compare.service';
import { v4 as uuidv4 } from 'uuid';
import { Observable } from 'rxjs';
import { IProductSimple } from 'src/app/shared/models/IProduct';
import { ToastrService } from 'ngx-toastr';

@Component({
  selector: 'app-compare-menu',
  templateUrl: './compare-menu.component.html',
  styleUrls: ['./compare-menu.component.scss'],
})

export class CompareMenuComponent implements OnInit {
  @Output() CompareEvent = new EventEmitter<any>();
  form!: FormGroup;

  bsModalRef!: BsModalRef;
  criterias: ICompareCriteria[] = [];
  selectAll: boolean = false;
  scenarios: IScenario[] = [];

  selectedScenario: IScenario | null = null;

  id = '';

  criteriaType = 1;
  modifierType = 1;

  isModalOpen = false;

  timeframeList = ['7 days', '30 days', '90 days', 'Last Year'];
  packagesList = [
    'PET 250 ml to 450 ml',
    'PET 500 ml to 1L',
    'PET 1.25L to 1.75L',
    'PET 2L',
    'PET 3L',
    'Cans 200 ml to 300 ml',
    'Cans 310 ml to 335 ml',
    'Cans 400 ml to 475 ml',
    'Returnables 190 ml to 350 ml',
    'Returnables 500 ml',
    'Returnables 1L',
    'TetraPak 150 ml to 350 ml',
    'TetraPak 500 ml',
    'TetraPak 1L'
  ];
  shiftsList = ['Shift 1', 'Shift 2', 'Shift 3'];
  productTypeList = [
    'Carbonated Drinks',
    'Juices',
    'Sports Drinks',
    'Teas',
    'Water',
  ];

  products: IProductSimple[] = [];
  searchUserForm: any;

  constructor(
    private compareService: CompareService,
    private toastr: ToastrService
  ) {}

  ngOnInit(): void {
    this.initForm();
    this.compareService.getProducts().subscribe((data) => {
      this.products = data;
    });

    this.compareService.loadScenarios().subscribe((data) => {
      this.scenarios = data;
    });
  }

  addScenario(): void {
    const value = this.form.value;

    const newScenario = {
      scenarioName: value.scenarioName,
      criterias: this.criterias,
      shifts: value.shifts,
      timeframe: value.timeframe,
      id: uuidv4(),
    };

    this.scenarios.push(newScenario);

    this.compareService.saveScenario(newScenario).subscribe();

    this.criterias = [];
    this.form.reset();
  }

  removeScenario(): void {
    if (this.selectedScenario) {
      const index = this.scenarios.findIndex(
        (it) => it.id === this.selectedScenario?.id
      );
      if (index === -1) return;

      this.compareService.deleteScenario(this.selectedScenario.id).subscribe();
      this.scenarios.splice(index, 1);
      this.form.reset();
      this.selectedScenario = null;
      this.criterias = [];
    }
  }

  toggleSelectAll() {
    this.selectAll = !this.selectAll;
  }

  selectScenario(event: any): void {
    console.log(event);
    const id = event.source.value;
    const foundScenario = this.scenarios.find((it) => it.id === id);
    if (foundScenario) {
      this.selectedScenario = foundScenario;
      this.criterias = foundScenario.criterias;

      this.form.patchValue({
        scenarioName: foundScenario.scenarioName,
        timeframe: foundScenario.timeframe,
        shifts: foundScenario.shifts,
      });
    }
  }
  monthsList = ['January', 'February ', 
  'March', 'April ', 'May ',
   'June ', 'July ', 'August',
    'September ', 'October ', 'November',
     'December ']

  handleEditCreateCriteria(): void {
    console.log(this.form.get('criteria'));
    if (!this.form.get('criteria')?.valid) {
      this.toastr.error('Need to select at least one of each!');
      return;
    }

    const value = this.form.value.criteria;

    const criteria: ICompareCriteria = {
      packagesGroup: [],
      productType: [],
      modifierType: value.modifierType,
      modifierValue: value.quantity,
      id: uuidv4(),
      product: [],
      criteriaType: value.criteriaType,
    };

    if (value.criteriaType === 1) {
      criteria.packagesGroup = value.packagesGroup;
      criteria.productType = value.productType;
    } else criteria.product = value.product;

    if (!this.id) {
      this.criterias.push(criteria);
    } else {
      const index = this.criterias.findIndex((x) => x.id === this.id);
      this.criterias.splice(index, 1, criteria);
      this.id = '';
    }

    this.closeModal();

    this.form.patchValue({
      criteria: {
        criteriaType: 1,
        packagesGroup: [],
        type: [],
        product: [],
        modifierType: 1,
        quantity: 5,
      },
    });

    this.modifierType = 1;
    this.criteriaType = 1;
  }

  removeCriteria(uuid: string): void {
    const index = this.criterias.findIndex((x) => x.id === uuid);
    if (index !== -1) {
      this.criterias.splice(index, 1);
    }
  }

  initForm(): void {
    this.form = new FormGroup({
      scenarioName: new FormControl('', [Validators.required]),
      timeframe: new FormControl('', [Validators.required]),
      shifts: new FormControl('', [Validators.required]),
      criteria: new FormGroup({
        criteriaType: new FormControl(1, [Validators.required]),
        packagesGroup: new FormControl([], []),
        productType: new FormControl([], []),
        product: new FormControl([], []),
        modifierType: new FormControl(1, [Validators.required]),
        quantity: new FormControl(5, [Validators.required]),
      }),
    });

    this.form
      .get('criteria')
      ?.get('criteriaType')
      ?.valueChanges.subscribe((value) => {
        this.criteriaType = value;
        this.modifierType = 1;
      });

    this.form
      .get('criteria')
      ?.get('modifierType')
      ?.valueChanges.subscribe((value) => {
        this.modifierType = value;
      });
  }

  generateString(criteria: ICompareCriteria): string {
    if (criteria.criteriaType === 1)
      return `${criteria.packagesGroup.join(', ')} (${criteria.modifierValue} ${
        criteria.modifierType === 1 ? '%' : 'qnt'
      })`;
    else
      return `${criteria.product[0]} (${criteria.modifierValue} ${
        criteria.modifierType === 1 ? '%' : 'qnt'
      })`;
  }

  checkVariable() {
    console.log(this.criteriaType);
  }

  getButtonClass() {
    return {
      'check yellow': this.id !== '',
      'plus green': this.id === '',
    };
  }

  openModal(uuid?: string): void {
    if (uuid) {
      this.id = uuid;
      const criteria = this.criterias.find((x) => x.id === uuid);
      if (criteria) {
        console.log(criteria);
        this.form.patchValue({
          criteria: {
            criteriaType: criteria.criteriaType,
            packagesGroup: criteria.packagesGroup,
            productType: criteria.productType,
            product: criteria.product,
            modifierType: criteria.modifierType,
            quantity: criteria.modifierValue,
          },
        });
        this.criteriaType = criteria.criteriaType;
        this.modifierType = criteria.modifierType;
      }
    }

    this.isModalOpen = true;
  }

  closeModal(): void {
    this.id = '';
    this.isModalOpen = false;
  }
}
