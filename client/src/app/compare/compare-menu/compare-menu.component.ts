import { Component, OnInit, Output, EventEmitter } from '@angular/core';
import { FormArray, FormControl, FormGroup, Validators } from '@angular/forms';
import { BsModalRef, BsModalService } from 'ngx-bootstrap/modal';
import { ICompareCriteria, IScenario } from 'src/app/shared/models/ICompare';
import { CompareService } from '../compare.service';
import { v4 as uuidv4 } from 'uuid';

@Component({
  selector: 'app-compare-menu',
  templateUrl: './compare-menu.component.html',
  styleUrls: ['./compare-menu.component.scss'],
})
export class CompareMenuComponent implements OnInit {
  @Output() CompareEvent = new EventEmitter<any>();
  form!: FormGroup;

  bsModalRef!: BsModalRef;
  criterias: ICompareCriteria[] = [];

  scenarios: IScenario[] = [];

  selectedScenario: IScenario | null = null;

  id = '';

  addScenario(): void {
    const value = this.form.value;

    this.scenarios.push({
      scenarioName: value.scenarioName,
      criterias: this.criterias,
      shifts: value.shifts,
      timeframe: value.timeframe,
      uuid: uuidv4(),
    });

    this.criterias = [];
    this.form.patchValue({
      scenarioName: 'Scenario ' + this.scenarios.length + 1,
      quantityType: 'perc',
      quantity: 5,
      packageGroups: this.packagesList.at(0),
      productTypes: [true, true, true, true, true],
    });
  }
  removeScenario(): void {
    if (this.selectedScenario) {
      const index = this.scenarios.findIndex(
        (it) => it.uuid === this.selectedScenario?.uuid
      );
      if (index === -1) return;

      this.scenarios.splice(index, 1);
      this.form.patchValue({
        scenarioName: 'Scenario ' + this.scenarios.length + 1,
        quantityType: 'perc',
        quantity: 5,
        packageGroups: this.packagesList.at(0),
        productTypes: [true, true, true, true, true],
      });
      this.selectedScenario = null;
      this.criterias = [];
    }
  }

  selectScenario(event: any): void {
    const id = event.target.value;
    const foundScenario = this.scenarios.find((it) => it.uuid === id);
    if (foundScenario) this.selectedScenario = foundScenario;
  }

  handleEditCreateCriteria(): void {
    const value = this.form.value;

    if (this.id) {
      this.criterias.push({
        packagesGroup: value.packageGroups,
        productType: value.productTypes
          .map((value: boolean, index: number) => {
            if (value) return this.productTypeList[index];
            return '';
          })
          .filter((it: string) => it !== ''),
        compareQuantity: {
          type: value.quantityType,
          value: value.quantity,
        },
        uuid: uuidv4(),
      });
    } else {
      const index = this.criterias.findIndex((x) => x.uuid === this.id);

      this.criterias.splice(index, 1, {
        packagesGroup: value.packageGroups,
        productType: value.productTypes
          .map((value: boolean, index: number) => {
            if (value) return this.productTypeList[index];
            return '';
          })
          .filter((it: string) => it !== ''),
        compareQuantity: {
          type: value.quantityType,
          value: value.quantity,
        },
        uuid: uuidv4(),
      });

      this.id = '';
    }

    this.form.patchValue({
      quantityType: 'perc',
      quantity: 5,
      packageGroups: this.packagesList.at(0),
      productTypes: [true, true, true, true, true],
    });
  }

  removeCriteria(uuid: string): void {
    const index = this.criterias.findIndex((x) => x.uuid === uuid);
    if (index !== -1) {
      this.criterias.splice(index, 1);
    }
  }
  timeframeList = ['7 days', '30 days', '90 days', 'Last Year'];
  packagesList = [
    'PET 250 ml to 450 ml',
    'PET 500 ml to 1L',
    'PET 1.25L to 1.75L',
    'PET 2L',
    'PET 3L',
    'Cans 200 ml to 300 ml',
    'Cans 310 ml to 335 ml',
    'Cans 400 ml to 475 ml',
    'Returnables 190 ml to 350 ml',
    'Returnables 500 ml',
    'Returnables 1L',
    'TetraPak 150 ml to 350 ml',
    'TetraPak 500 ml',
    'TetraPak 1L',
  ];
  shiftsList = ['Shift 1', 'Shift 2', 'Shift 3'];
  productTypeList = [
    'Carbonated Drinks',
    'Juices',
    'Sports Drinks',
    'Teas',
    'Water',
  ];

  constructor() {}

  ngOnInit(): void {
    this.initForm();
  }

  editCriteria(criteria: ICompareCriteria): void {
    this.id = criteria.uuid;

    const productTypes = Array(5).fill(false, 0, 5);
    criteria.productType.forEach((item) => {
      const indexOfProductTypeList = this.productTypeList.findIndex(
        (x) => x === item
      );
      productTypes[indexOfProductTypeList] = true;
    });

    this.form.patchValue({
      quantityType: criteria.compareQuantity.type,
      quantity: criteria.compareQuantity.value,
      packageGroups: criteria.packagesGroup,
      productTypes,
    });
  }

  cancelEditCriteria(): void {
    this.id = '';
    this.form.patchValue({
      quantityType: 'perc',
      quantity: 5,
      packageGroups: this.packagesList.at(0),
      productTypes: [true, true, true, true, true],
    });
  }

  initForm(): void {
    this.form = new FormGroup({
      scenarioName: new FormControl(
        'Scenario ' + this.scenarios.length + 1,
        []
      ),
      timeframe: new FormControl('', []),
      shifts: new FormControl('', []),
      quantityType: new FormControl('perc', []),
      quantity: new FormControl('5', [Validators.required]),
      packageGroups: new FormControl(this.packagesList.at(0), [
        Validators.required,
      ]),
      productTypes: new FormArray([
        new FormControl(true, []),
        new FormControl(true, []),
        new FormControl(true, []),
        new FormControl(true, []),
        new FormControl(true, []),
      ]),
    });
  }

  generateString(criteria: ICompareCriteria): string {
    return `${criteria.packagesGroup} (${criteria.compareQuantity.value} ${
      criteria.compareQuantity.type === 'perc' ? '%' : 'qnt'
    })`;
  }

  getButtonClass() {
    return {
      'check yellow': this.id !== '',
      'plus green': this.id === '',
    };
  }
}
