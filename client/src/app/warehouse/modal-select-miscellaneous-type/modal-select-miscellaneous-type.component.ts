import {
  AfterViewInit,
  Component,
  Input,
  OnInit,
  ViewChild,
} from '@angular/core';
import { FormControl, FormGroup, Validators } from '@angular/forms';
import { Store } from '@ngrx/store';
import { BsModalRef } from 'ngx-bootstrap/modal';
import { AppState } from 'src/app/reducer/rootReducer';
import { IDropdown } from 'src/app/shared/models/IDropdown';
import { WarehouseService } from '../warehouse.service';

import * as PIXI from 'pixi.js';
import { IMiscellaneousType } from 'src/app/shared/models/IMiscellaneous';

@Component({
  selector: 'app-modal-select-miscellaneous-type',
  templateUrl: './modal-select-miscellaneous-type.component.html',
  styleUrls: ['./modal-select-miscellaneous-type.component.scss'],
})
export class ModalSelectMiscellaneousTypeComponent
  implements OnInit, AfterViewInit
{
  @Input() title: string = '';
  @Input() gameInstance: any;
  @ViewChild('pixiContainer', { static: true }) pixiContainer: any;
  miscellaneousForm!: FormGroup;

  miscellaneousTypeSelected: IMiscellaneousType | undefined;

  private app: PIXI.Application = new PIXI.Application({
    width: 350,
    height: 350,
    backgroundColor: 0xececec,
    antialias: true,
  });

  constructor(
    public bsModalRef: BsModalRef,
    private warehouseService: WarehouseService,
    private store: Store<AppState>
  ) {}

  ngAfterViewInit(): void {
    this.pixiContainer.nativeElement.appendChild(this.app.view as any);
  }

  miscellanousDropdown: IDropdown[] = [];

  ngOnInit(): void {
    this.createMiscellaneousTypeForm();
  }

  onSubmit(): void {}

  closeModal(): void {
    this.bsModalRef.hide();
  }

  createMiscellaneousTypeForm(): void {
    this.miscellaneousForm = new FormGroup({
      miscellaneousType: new FormControl('', [Validators.required]),
      sizeX: new FormControl('0', [Validators.required, Validators.min(0)]),
      sizeY: new FormControl('0', [Validators.required, Validators.min(0)]),
      rotation: new FormControl(''),
    });

    this.miscellaneousForm
      .get('rotation')
      ?.valueChanges.subscribe((value) => {});
  }

  drawPreview(): void {
    if (!this.miscellaneousTypeSelected) return;

    let width = this.miscellaneousTypeSelected.sizeX * 100.0;
    let height = this.miscellaneousTypeSelected.sizeY * 100.0;
    for (let i = 1; i <= 5; i++) {
      if (width >= this.app.view.width || height >= this.app.view.height) {
        width /= i;
        height /= i;
      } else break;
    }

    const position = [
      this.app.view.width / 2.0 - width / 2.0,
      this.app.view.height / 2.0 - height / 2.0,
    ];

    const graphics = new PIXI.Graphics();
    graphics.lineStyle(2, 0x00, 1);
    graphics.beginFill(0xfad985);
    graphics.drawRect(position[0], position[1], width, height);
    graphics.endFill();

    this.app.stage.addChild(graphics);
  }
}
