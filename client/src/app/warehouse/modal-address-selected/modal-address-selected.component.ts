import {
    Component,
    Input,
    OnInit,
    ViewChild,
    AfterViewInit,
    ElementRef,
  } from '@angular/core';
  import { FormControl, FormGroup, Validators } from '@angular/forms';
  import { Store } from '@ngrx/store';
  import { BsModalRef } from 'ngx-bootstrap/modal';
  import * as PIXI from 'pixi.js';
  import { firstValueFrom } from 'rxjs';
  import { AppState } from 'src/app/reducer/rootReducer';
  import { IDropdown } from 'src/app/shared/models/IDropdown';
  import { IPositionTypeBin } from 'src/app/shared/models/IPositionTypeBin';
  import { WarehouseService } from 'src/app/warehouse/warehouse.service';
  import { SetCurrentPositionTypeBin } from '../warehouse-redux/warehouseAction';
import * as THREE from "three";

  @Component({
    selector: 'app-modal-address-selected',
    templateUrl: './modal-address-selected.component.html',
    styleUrls: ['./modal-address-selected.component.scss'],
  })
  export class ModalAddressSelectedComponent implements OnInit, AfterViewInit {
    @Input() title: string = '';
    @Input() gameInstance: any;
    @ViewChild('pixiContainer', { static: true }) pixiContainer: any;
    typeForm!: FormGroup;

    @ViewChild('canvas')
    private canvasRef!: ElementRef;

    @Input() public rotationSpeedX: number = 0.05;
    @Input() public rotationSpeedY: number = 0.01;

    @Input() public size: number = 200;

    @Input() public texture: string = "assets/texture.jgp";


    @Input() public cameraZ: number = 400;

    @Input() public fieldOfView: number = 1;

    @Input('nearClipping') public nearClippingPlane: number = 1;

    @Input('farClipping') public farClippingPlane: number = 1000;

    private camera!: THREE.PerspectiveCamera;

    private get canvas(): HTMLCanvasElement { 
      return this.canvasRef.nativeElement;
    }

    private loader = new THREE.TextureLoader();
    private geometry = new THREE.BoxGeometry(3, 1, 3);
    private material = new THREE.MeshBasicMaterial({ map: this.loader.load(this.texture) });

    private cube: THREE.Mesh = new THREE.Mesh(this.geometry, this.material);

    private renderer!: THREE.WebGLRenderer;

    private scene!: THREE.Scene;

    

    private createScene() {
      //* 
      this.scene = new THREE.Scene();
      this.scene.background = new THREE.Color(0x000000);
      this.scene.add(this.cube);

      let aspectRatio = this.getAspectRatio();
      this.camera = new THREE.PerspectiveCamera
        (
          this.fieldOfView,
          aspectRatio,
          this.nearClippingPlane,
          this.farClippingPlane
      )
      this.camera.position.z = this.cameraZ;
    }

    private startRendering() {
      this.renderer = new THREE.WebGLRenderer({ canvas: this.canvas });
      this.renderer.setPixelRatio(devicePixelRatio);
      this.renderer.setSize(390, 360);
      
      let component: ModalAddressSelectedComponent = this;
      (function render() {
        component.renderer.render(component.scene, component.camera);
      })
    }

    getAspectRatio() {
      return this.canvas.clientWidth / this.canvas.clientHeight;
    }

    positionTypeBins: IPositionTypeBin[] = [];
    productId: string = "055200";
    addressTypeDropDown: IDropdown[] = [
      {
        text: "A01",
        value: 1,
      },
      {
        text: "A02",
        value: 2,
      },
      {
        text: "A03",
        value: 3,
      },
      {
        text: "A04",
        value: 4,
      },
      {
        text: "A05",
        value: 5,
      },
      {
        text: "A06",
        value: 6,
      },
    ];
  
    positionTypeSelected: IPositionTypeBin | undefined = undefined;
  
    accessSideDropdown: IDropdown[] = [
      {
        text: 'Up',
        value: 0,
      },
      {
        text: 'Right',
        value: 1,
      },
      {
        text: 'Down',
        value: 2,
      },
      {
        text: 'Left',
        value: 3,
      },
    ];
  
    private app: PIXI.Application = new PIXI.Application({
      width: 350,
      height: 350,
      backgroundColor: 0xececec,
      antialias: true,
    });
  
    constructor(
      public bsModalRef: BsModalRef,
      private warehouseService: WarehouseService,
      private store: Store<AppState>
    ) {}
  
    ngAfterViewInit(): void {
      this.createScene();
      this.startRendering();
    }
    ngOnInit(): void {
      // this.loadPositionTypeBins();
      // this.createTypeForm();
    }
  
    onSubmit(): void {
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'HandleSpawnMode',
        'true'
      );
      this.closeModal();
    }
  
    closeModal(): void {
      this.bsModalRef.hide();
    }
  }
  