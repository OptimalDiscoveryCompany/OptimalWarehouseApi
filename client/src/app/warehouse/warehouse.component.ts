import { HttpClient } from '@angular/common/http';
import { Component, Input, isDevMode, OnInit } from '@angular/core';
import { MatDialog } from '@angular/material';
import { Store } from '@ngrx/store';
import { BsModalRef, BsModalService } from 'ngx-bootstrap/modal';
import { AppState } from '../reducer/rootReducer';
import { IAddress } from '../shared/models/IAddress';
import { ModalAddressDetailComponent } from './modal-address-detail/modal-address-detail.component';
import { ModalSelectTypeAddressComponent } from './modal-select-type-address/modal-select-type-address.component';
import { WarehouseService } from './warehouse.service';

@Component({
  selector: 'app-warehouse',
  templateUrl: './warehouse.component.html',
  styleUrls: ['./warehouse.component.scss'],
})

export class WarehouseComponent implements OnInit {
  unityInstance: any;
  progress = 0;
  isReady = false;
  gameInstance: any;
  switchMenu: any;
  bsModalRef!: BsModalRef;

  warehouseStore = this.store.select((state) => state.warehouse);

  addresses2d: IAddress[] = [];

  constructor(
    private http: HttpClient,
    private modalService: BsModalService,
    private store: Store<AppState>,
    private warehouseService: WarehouseService,
    public dialog: MatDialog
  ) {}

  ngOnInit() {
    this.warehouseStore.subscribe((s) => {
      this.gameInstance?.SendMessage(
        'JavaScriptMessager',
        'RecvJsonWithAddressDim',
        JSON.stringify(s.currentPositionTypeBin)
      );
      this.gameInstance?.SendMessage(
        'JavaScriptMessager',
        'HandleKeyboard',
        'false'
      );
    });

    this.warehouseStore.subscribe(({ addresses }) => {
      const json = JSON.stringify(addresses);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadAddresses',
        json
      );
    });

    if (!window.unityEvents) window.unityEvents = {};
    window.unityEvents.saveEvent = (data: string) => {
      const addresses: IAddress[] = JSON.parse(data);
      addresses.forEach((item) => delete item.id);
      this.warehouseService.saveAddresess(addresses).subscribe();
    };

    window.unityEvents.onClick2DAddress = (id: number) => {
      this.bsModalRef = this.modalService.show(ModalAddressDetailComponent, {
        class: 'modal-lg',
        initialState: {
          title: 'Address Detail',
          id: id,
        },
      });
    };
  }

  onClickCreate2D(): void {
    this.warehouseService.loadAddresses();

    this.http.get('assets/miscellaneousLayout.json').subscribe((data) => {
      const json = JSON.stringify(data);
      console.log(json);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadMiscellaneous',
        json
      );
    });

    // LoadMiscellaneous
  }

  onClickLoadHeatMapFlowData(): void {
    this.http.get('assets/points.json').subscribe((data) => {
      const json = JSON.stringify(data);

      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadHeatMapFlow',
        json
      );
    });
  }

  openModal(): void {
    this.gameInstance.SendMessage(
      'JavaScriptMessager',
      'HandleKeyboard',
      'false'
    );
    this.bsModalRef = this.modalService.show(ModalSelectTypeAddressComponent, {
      class: 'modal-lg',
      initialState: {
        title: 'Area Picking',
      },
    });
  }

  openModalDev(): void {
    this.gameInstance.SendMessage(
      'JavaScriptMessager',
      'HandleKeyboard',
      'false'
    );
    this.bsModalRef = this.modalService.show(ModalAddressDetailComponent, {
      class: 'modal-lg',
      initialState: {
        title: 'Address Detail',
      },
    });
  }

  onSave(): void {
    this.gameInstance.SendMessage('JavaScriptMessager', 'SaveAddressToDB');
  }

  onClickCreate3D(): void {
    this.http.get('assets/address_3d.json').subscribe((data: any) => {
      data.forEach((item: any) => {
        item.hostName = '';
        if (isDevMode()) {
          item.hostName = 'http://localhost:5003';
        }
      });
      this.gameInstance.SendMessage(
        'EventSystem',
        'LoadAddress',
        JSON.stringify(data)
      );
    });

    this.http.get('assets/miscellaneousLayout.json').subscribe((data: any) => {
      this.gameInstance.SendMessage(
        'EventSystem',
        'LoadMiscellaneous',
        JSON.stringify(data)
      );
    });
  }

  setGameInstance(event: { gameInstance: any }): void {
    this.gameInstance = event.gameInstance;
  }

  setSwitch(event: { switchMenu: any }): void {
    this.switchMenu = event.switchMenu;
  }

  openDialog(): void {
    const dialogRef = this.dialog.open(ModalAddressDetailComponent);
    dialogRef.afterClosed().subscribe((result) => {
      console.log(`Dialog result: ${result}`);
    });
  }
}
