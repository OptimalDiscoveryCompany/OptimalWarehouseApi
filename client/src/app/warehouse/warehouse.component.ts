import { HttpClient } from '@angular/common/http';
import { Component, Input, isDevMode, OnInit } from '@angular/core';
import { Store } from '@ngrx/store';
import { BsModalRef, BsModalService } from 'ngx-bootstrap/modal';
import { AppState } from '../reducer/rootReducer';
import { ModalSelectTypeAddressComponent } from './modal-select-type-address/modal-select-type-address.component';

@Component({
  selector: 'app-warehouse',
  templateUrl: './warehouse.component.html',
  styleUrls: ['./warehouse.component.scss'],
})
export class WarehouseComponent implements OnInit {
  unityInstance: any;
  @Input() appLocation: string = 'assets/demo/demo.json';
  @Input() appWidth: string = '800';
  @Input() appHeight: string = '600';
  progress = 0;
  isReady = false;
  gameInstance: any;
  bsModalRef!: BsModalRef;

  warehouseStore = this.store.select((state) => state.warehouse);

  constructor(
    private http: HttpClient,
    private modalService: BsModalService,
    private store: Store<AppState>
  ) {}

  ngOnInit() {
    const loader = (window as any).UnityLoader;

    console.log(loader);
    this.unityInstance = loader.instantiate(
      'unityContainer',
      `assets/build/Build/build.json`,
      {
        onProgress: (gameInstance: any, progress: number) => {
          this.isReady = true;
          this.gameInstance = gameInstance;
        },
      }
    );

    this.warehouseStore.subscribe((s) => console.log(s.currentPositionTypeBin));
  }

  onClickCreate3D(): void {
    this.http.get('assets/address_3d.json').subscribe((data: any) => {
      data.forEach((item: any) => {
        item.hostName = '';
        if (isDevMode()) {
          item.hostName = 'http://localhost:5003';
        }
      });
      this.gameInstance.SendMessage(
        'EventSystem',
        'LoadAddress',
        JSON.stringify(data)
      );
    });

    this.http.get('assets/miscellaneousLayout.json').subscribe((data: any) => {
      this.gameInstance.SendMessage(
        'EventSystem',
        'LoadMiscellaneous',
        JSON.stringify(data)
      );
    });
  }

  onClickCreate2D(): void {
    this.http.get('assets/addressLayout.json').subscribe((data) => {
      const json = JSON.stringify(data);
      console.log(json);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadAddresses',
        json
      );
    });

    this.http.get('assets/miscellaneousLayout.json').subscribe((data) => {
      const json = JSON.stringify(data);
      console.log(json);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadMiscellaneous',
        json
      );
    });

    // LoadMiscellaneous
  }

  onClickLoadHeatMapFlowData(): void {
    this.http.get('assets/points.json').subscribe((data) => {
      const json = JSON.stringify(data);
      console.log(json);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadHeatMapFlow',
        json
      );
    });
  }

  openModal(): void {
    this.bsModalRef = this.modalService.show(ModalSelectTypeAddressComponent, {
      class: 'modal-lg',
      initialState: {
        title: 'Area Picking',
      },
    });
  }
}
