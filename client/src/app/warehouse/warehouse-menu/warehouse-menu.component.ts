import { HttpClient } from '@angular/common/http';
import { Component, Input, OnInit } from '@angular/core';
import { FormControl, FormGroup } from '@angular/forms';
import { BsModalRef, BsModalService } from 'ngx-bootstrap/modal';
import { IAddress } from 'src/app/shared/models/IAddress';
import { IDropdown } from 'src/app/shared/models/IDropdown';
import {
  IWarehouseController,
  IWarehouseControllerType,
} from 'src/app/shared/models/IWarehouseController';
import { ModalSelectMiscellaneousTypeComponent } from '../modal-select-miscellaneous-type/modal-select-miscellaneous-type.component';
import { ModalSelectTypeAddressComponent } from '../modal-select-type-address/modal-select-type-address.component';
import { WarehouseUnityUtils } from '../warehouse-unity-utils/warehouseUnityUtils';
import { WarehouseService } from '../warehouse.service';

import { IndicatorType } from '../../shared/models/IndicatorType';
import { map } from 'rxjs';
import { IScenarioSimplyfied } from 'src/app/shared/models/ICompare';
import { CompareService } from 'src/app/compare/compare.service';

@Component({
  selector: 'app-warehouse-menu',
  templateUrl: './warehouse-menu.component.html',
  styleUrls: ['./warehouse-menu.component.scss'],
})
export class WarehouseMenuComponent implements OnInit {
  items = ['Address', 'Miscellaneous'];
  expandedIndex = 0;
  bsModalRef!: BsModalRef;

  addresses: IAddress[] = [];

  @Input() gameInstance: any;

  @Input() switchMenu: any;

  warehouseController!: IWarehouseController;

  formDropdown!: FormGroup;

  isNewPointsSelected: boolean = false;

  indicatorTypesDropdown: IDropdown[] = [
    {
      text: 'None',
      value: IndicatorType.None,
    },
    {
      text: 'Picks',
      value: IndicatorType.Picks,
    },
    {
      text: 'Cases Picked',
      value: IndicatorType.CasesPicked,
    },
    {
      text: 'Restocks',
      value: IndicatorType.Restocks,
    },
    {
      text: 'Out of Stocks',
      value: IndicatorType.OutOfStocks,
    },
    {
      text: 'Heat Map',
      value: IndicatorType.HeatMap,
    },
    {
      text: 'Products Changes',
      value: IndicatorType.ProductsChange,
    },
  ];

  indicatorSelected = IndicatorType.None;

  startDate: Date;
  endDate: Date;

  scenarioName = 'Actual';
  scenarios: IScenarioSimplyfied[] = [];

  constructor(
    private warehouseService: WarehouseService,
    private http: HttpClient,
    private modalService: BsModalService,
    private compareService: CompareService
  ) {
    this.startDate = new Date();
    this.endDate = new Date();
  }

  ngOnInit(): void {
    if (!window.unityEvents) window.unityEvents = {};

    window.unityEvents.saveEvent = (data: string) => {
      const addresses: IAddress[] = JSON.parse(data);
      addresses.forEach((item) => delete item.id);
      this.warehouseService.saveAddresess(addresses).subscribe();
    };

    window.unityEvents.load2D = () => {
      const json = JSON.stringify(this.addresses);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadAddresses',
        json
      );
    };

    window.unityEvents.onKeyboardArrowsDownChange = (value: string) => {
      this.formDropdown.get('selectIndicatorDropdown')?.setValue(value);
    };

    this.warehouseController = {
      isCameraMode: {
        isEnable: true,
        action: WarehouseUnityUtils.handleCameraModeGameInstance,
      },
      isDragMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleDragModeGameInstance,
      },
      isSelectionMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleSelectionModeGameInstance,
      },
      isSpawnMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleSpawnModeGameInstance,
      },
      isMetrics: {
        isEnable: false,
        action: WarehouseUnityUtils.handleMetricModeGameInstance,
      },
      isHeatMapFlow2DMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleHeatMapFlow2D,
      },
      isHeatMapPerAddress2DMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleHeatMapPerAddress2D,
      },
      isProductsChanges: {
        isEnable: false,
        action: WarehouseUnityUtils.handleProductChanges,
      },
      isMiscellaneousMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleMiscellaneous,
      },
    };
    this.compareService
      .loadScenarios()
      .pipe(
        map((value) => {
          return value.map((item) => {
            const scenarioSimple: IScenarioSimplyfied = {
              id: item.id,
              scenarioName: item.scenarioName,
            };
            return scenarioSimple;
          });
        })
      )
      .subscribe((data) => {
        this.scenarios = data;
      });

    this.initFormControl();
  }

  initFormControl(): void {
    this.formDropdown = new FormGroup({
      selectIndicatorDropdown: new FormControl('None'),
      selectScenarioDropdown: new FormControl('current'),
    });

    this.formDropdown
      .get('selectIndicatorDropdown')
      ?.valueChanges.subscribe((value: any) => {
        if (!this.switchMenu) this.indicatorSelected = value;
      });
  }

  load2DAreaPicking(scenarioName: string): void {
    this.warehouseService.loadAddresses(scenarioName);

    this.http.get('assets/miscellaneousLayout.json').subscribe((data) => {
      const json = JSON.stringify(data);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadMiscellaneous',
        json
      );
    });
  }

  onScenarioChange(event: any): void {
    this.scenarioName = event.source.value;
    this.load2DAreaPicking(this.scenarioName);
  }

  openAddressTypeModal(): void {
    this.gameInstance.SendMessage(
      'JavaScriptMessager',
      'HandleKeyboard',
      'false'
    );
    this.bsModalRef = this.modalService.show(ModalSelectTypeAddressComponent, {
      class: 'modal-lg',
      initialState: {
        title: 'Address Type',
        gameInstance: this.gameInstance,
      },
    });
  }

  openMiscellaneousTypeModal(): void {
    this.gameInstance.SendMessage(
      'JavaScriptMessager',
      'HandleKeyboard',
      'false'
    );
    this.bsModalRef = this.modalService.show(
      ModalSelectMiscellaneousTypeComponent,
      {
        class: 'modal-lg',
        initialState: {
          title: 'Miscellaneous',
          gameInstance: this.gameInstance,
        },
      }
    );
  }

  handleCamera(): void {
    this.handleWarehouseControl([IWarehouseControllerType.isCameraMode], []);
  }

  handleSpawnMode(): void {
    this.handleWarehouseControl(
      [IWarehouseControllerType.isSpawnMode],
      [
        IWarehouseControllerType.isSelectionMode,
        IWarehouseControllerType.isDragMode,
      ]
    );
  }

  handleSelectionMode(): void {
    this.handleWarehouseControl(
      [IWarehouseControllerType.isSelectionMode],
      [
        IWarehouseControllerType.isSpawnMode,
        IWarehouseControllerType.isDragMode,
        IWarehouseControllerType.isCameraMode,
      ]
    );
  }

  handleDragMode(): void {
    this.handleWarehouseControl(
      [IWarehouseControllerType.isDragMode],
      [
        IWarehouseControllerType.isCameraMode,
        IWarehouseControllerType.isSpawnMode,
      ]
    );
  }

  handleMetrics(): void {
    this.handleWarehouseControl(
      [IWarehouseControllerType.isMetrics],
      [
        IWarehouseControllerType.isSelectionMode,
        IWarehouseControllerType.isDragMode,
      ]
    );
  }

  handleMiscellaneous(): void {
    this.handleWarehouseControl(
      [IWarehouseControllerType.isMiscellaneousMode],
      []
    );
    this.gameInstance.SendMessage('JavaScriptMessager', 'ClearMiscellaneous');
    if (!this.warehouseController.isMiscellaneousMode.isEnable) {
      this.http.get('assets/miscellaneousLayout.json').subscribe((data) => {
        const json = JSON.stringify(data);
        this.gameInstance.SendMessage(
          'JavaScriptMessager',
          'LoadMiscellaneous',
          json
        );
      });
    } else {
      this.http
        .get('assets/miscellaneousLayoutParcial.json')
        .subscribe((data) => {
          const json = JSON.stringify(data);
          this.gameInstance.SendMessage(
            'JavaScriptMessager',
            'LoadMiscellaneous',
            json
          );
        });
    }
  }

  //handle indicators
  handleHeatMapFlow(): void {
    this.warehouseService
      .loadHeatMapFlow2D(this.startDate, this.endDate)
      .subscribe((data) => {
        this.handleWarehouseControl(
          [IWarehouseControllerType.isHeatMapFlow2DMode],
          [
            IWarehouseControllerType.isMetrics,
            IWarehouseControllerType.isSelectionMode,
            IWarehouseControllerType.isSpawnMode,
          ],
          data
        );
      });
  }

  handleOutOfStock(): void {
    this.warehouseService
      .loadStaticIndicators()
      .pipe(map((data) => data.outOfStock))
      .subscribe((data) => {
        this.handleWarehouseControl(
          [IWarehouseControllerType.isHeatMapPerAddress2DMode],
          [
            IWarehouseControllerType.isMetrics,
            IWarehouseControllerType.isSelectionMode,
            IWarehouseControllerType.isSpawnMode,
          ],
          data
        );
      });
  }

  handleRestocks(): void {
    this.warehouseService
      .loadStaticIndicators()
      .pipe(map((data) => data.restocks))
      .subscribe((data) => {
        this.handleWarehouseControl(
          [IWarehouseControllerType.isHeatMapPerAddress2DMode],
          [
            IWarehouseControllerType.isMetrics,
            IWarehouseControllerType.isSelectionMode,
            IWarehouseControllerType.isSpawnMode,
          ],
          data
        );
      });
  }

  handlePicks(): void {
    this.warehouseService
      .loadStaticIndicators()
      .pipe(map((data) => data.picks))
      .subscribe((data) => {
        this.handleWarehouseControl(
          [IWarehouseControllerType.isHeatMapPerAddress2DMode],
          [
            IWarehouseControllerType.isMetrics,
            IWarehouseControllerType.isSelectionMode,
            IWarehouseControllerType.isSpawnMode,
          ],
          data
        );
      });
  }

  handleCasesPicked(): void {
    this.warehouseService
      .loadStaticIndicators()
      .pipe(map((data) => data.casesPicked))
      .subscribe((data) => {
        this.handleWarehouseControl(
          [IWarehouseControllerType.isHeatMapPerAddress2DMode],
          [
            IWarehouseControllerType.isMetrics,
            IWarehouseControllerType.isSelectionMode,
            IWarehouseControllerType.isSpawnMode,
          ],
          data
        );
      });
  }

  handleAddressChanges(): void {
    this.warehouseService
      .loadScenariosChanges(this.scenarioName)
      .subscribe((data) => {
        this.handleWarehouseControl(
          [IWarehouseControllerType.isProductsChanges],
          [
            IWarehouseControllerType.isMetrics,
            IWarehouseControllerType.isSelectionMode,
            IWarehouseControllerType.isSpawnMode,
          ],
          data
        );
      });
  }

  //

  onAddressViewChange() {
    this.handleWarehouseControl(
      [],
      [
        IWarehouseControllerType.isHeatMapPerAddress2DMode,
        IWarehouseControllerType.isHeatMapFlow2DMode,
      ],
      []
    );
    switch (this.indicatorSelected) {
      case IndicatorType.ProductsChange:
        this.handleAddressChanges();
        break;
      default:
        break;
    }
  }

  onDateChange(isStart: boolean, event: any) {
    const value = event.value as Date;

    if (isStart) this.startDate = value;
    else this.endDate = value;

    switch (this.indicatorSelected) {
      case IndicatorType.CasesPicked:
        this.handleCasesPicked();
        break;
      case IndicatorType.HeatMap:
        this.handleHeatMapFlow();
        break;
      case IndicatorType.OutOfStocks:
        this.handleOutOfStock();
        break;
      case IndicatorType.Picks:
        this.handlePicks();
        break;
      case IndicatorType.Restocks:
        this.handleRestocks();
        break;
      default:
        break;
    }
  }

  handleRemove(): void {
    this.gameInstance.SendMessage('JavaScriptMessager', 'HandleRemove');
  }

  saveAddressToDB(): void {
    this.gameInstance.SendMessage('JavaScriptMessager', 'SaveAddressToDB');
  }

  handleWarehouseControl(
    enable: string[],
    disable: string[],
    data?: any
  ): void {
    for (var key in this.warehouseController) {
      if (enable.includes(key)) {
        this.warehouseController[key].isEnable = this.warehouseController[key]
          .isEnable
          ? false
          : true;
        this.handleLogicInCaseOpitionalParameterIsNotOptional(key, data);
      }
      if (disable.includes(key)) {
        this.warehouseController[key].isEnable = false;
        this.handleLogicInCaseOpitionalParameterIsNotOptional(key, data);
      }
    }
  }

  private handleLogicInCaseOpitionalParameterIsNotOptional(
    key: string,
    data: any
  ): void {
    if (data) {
      let newDataStruct = {
        isActive: this.warehouseController[key].isEnable,
        data: data,
      };

      this.warehouseController[key].action(
        this.gameInstance,
        this.warehouseController[key].isEnable,
        JSON.stringify(newDataStruct)
      );
    } else {
      this.warehouseController[key].action(
        this.gameInstance,
        this.warehouseController[key].isEnable
      );
    }
  }
}
