import { HttpClient } from '@angular/common/http';
import { Component, Input, OnInit } from '@angular/core';
import { FormControl, FormGroup } from '@angular/forms';
import { BsModalRef, BsModalService } from 'ngx-bootstrap/modal';
import { IAddress } from 'src/app/shared/models/IAddress';
import { IDropdown } from 'src/app/shared/models/IDropdown';
import {
  IWarehouseController,
  IWarehouseControllerType,
} from 'src/app/shared/models/IWarehouseController';
import { ModalSelectMiscellaneousTypeComponent } from '../modal-select-miscellaneous-type/modal-select-miscellaneous-type.component';
import { ModalSelectTypeAddressComponent } from '../modal-select-type-address/modal-select-type-address.component';
import { WarehouseUnityUtils } from '../warehouse-unity-utils/warehouseUnityUtils';
import { WarehouseService } from '../warehouse.service';

@Component({
  selector: 'app-warehouse-menu',
  templateUrl: './warehouse-menu.component.html',
  styleUrls: ['./warehouse-menu.component.scss'],
})
export class WarehouseMenuComponent implements OnInit {
  items = ['Address', 'Miscellaneous'];
  expandedIndex = 0;
  bsModalRef!: BsModalRef;

  addresses: IAddress[] = [];

  @Input() gameInstance: any;

  @Input() switchMenu: any;

  warehouseController!: IWarehouseController;

  formDropdown!: FormGroup;

  indicatorTypesDropdown: IDropdown[] = [
    {
      text: 'None',
      value: 'None',
    },
    {
      text: 'Picks',
      value: 'picks',
    },
    {
      text: 'Cases Picked',
      value: 'casespicked',
    },
    {
      text: 'Restock',
      value: 'restock',
    },
    {
      text: 'Out of Stocks',
      value: 'outofstock',
    },
  ];

  constructor(
    private warehouseService: WarehouseService,
    private http: HttpClient,
    private modalService: BsModalService
  ) {}

  ngOnInit(): void {
    if (!window.unityEvents) window.unityEvents = {};

    window.unityEvents.saveEvent = (data: string) => {
      const addresses: IAddress[] = JSON.parse(data);
      addresses.forEach((item) => delete item.id);
      this.warehouseService.saveAddresess(addresses).subscribe();
    };

    window.unityEvents.load2D = () => {
      const json = JSON.stringify(this.addresses);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadAddresses',
        json
      );
    };

    this.warehouseController = {
      isCameraMode: {
        isEnable: true,
        action: WarehouseUnityUtils.handleCameraModeGameInstance,
      },
      isDragMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleDragModeGameInstance,
      },
      isSelectionMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleSelectionModeGameInstance,
      },
      isSpawnMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleSpawnModeGameInstance,
      },
      isMetrics: {
        isEnable: false,
        action: WarehouseUnityUtils.handleMetricModeGameInstance,
      },
      isHeatMapFlow2DMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleHeatMapFlow2D,
      },
      isHeatMapPerAddress2DMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleHeatMapPerAddress2D,
      },
      isFlyMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleFlyMode,
      },
      isHeatMapPerAddress3DMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleHeatMapPerAddress3D,
      },
      isMiscellaneousMode: {
        isEnable: false,
        action: WarehouseUnityUtils.handleMiscellaneous,
      },
    };
    this.initFormControl();
  }

  initFormControl(): void {
    this.formDropdown = new FormGroup({
      selectIndicatorDropdown: new FormControl('None'),
    });

    this.formDropdown
      .get('selectIndicatorDropdown')
      ?.valueChanges.subscribe((value: string) => {
        if (!this.switchMenu) this.handleHeatMapPerAddress2D(value);
        else {
          this.handleHeatMapPerAddress3D(value);
        }
      });
  }

  load2DAreaPicking(): void {
    this.warehouseService.loadStatic2dAddresses().subscribe((data) => {
      this.addresses = data;
      const json = JSON.stringify(data);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadAddresses',
        json
      );
    });

    this.http.get('assets/miscellaneousLayout.json').subscribe((data) => {
      const json = JSON.stringify(data);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadMiscellaneous',
        json
      );
    });

    this.http.get('assets/points.json').subscribe((data) => {
      const json = JSON.stringify(data);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadHeatMapFlow',
        json
      );
    });
  }

  openAddressTypeModal(): void {
    this.gameInstance.SendMessage(
      'JavaScriptMessager',
      'HandleKeyboard',
      'false'
    );
    this.bsModalRef = this.modalService.show(ModalSelectTypeAddressComponent, {
      class: 'modal-lg',
      initialState: {
        title: 'Address Type',
        gameInstance: this.gameInstance,
      },
    });
  }
  openMiscellaneousTypeModal(): void {
    this.gameInstance.SendMessage(
      'JavaScriptMessager',
      'HandleKeyboard',
      'false'
    );
    this.bsModalRef = this.modalService.show(
      ModalSelectMiscellaneousTypeComponent,
      {
        class: 'modal-lg',
        initialState: {
          title: 'Miscellaneous',
          gameInstance: this.gameInstance,
        },
      }
    );
  }

  handleCamera(): void {
    this.handleWarehouseControl([IWarehouseControllerType.isCameraMode], []);
  }

  handleSpawnMode(): void {
    this.handleWarehouseControl(
      [IWarehouseControllerType.isSpawnMode],
      [
        IWarehouseControllerType.isSelectionMode,
        IWarehouseControllerType.isDragMode,
      ]
    );
  }

  handleSelectionMode(): void {
    this.handleWarehouseControl(
      [IWarehouseControllerType.isSelectionMode],
      [
        IWarehouseControllerType.isSpawnMode,
        IWarehouseControllerType.isDragMode,
        IWarehouseControllerType.isCameraMode,
      ]
    );
  }

  handleDragMode(): void {
    this.handleWarehouseControl(
      [IWarehouseControllerType.isDragMode],
      [
        IWarehouseControllerType.isCameraMode,
        IWarehouseControllerType.isSpawnMode,
      ]
    );
  }

  handleMetrics(): void {
    this.handleWarehouseControl(
      [IWarehouseControllerType.isMetrics],
      [
        IWarehouseControllerType.isSelectionMode,
        IWarehouseControllerType.isDragMode,
      ]
    );
  }

  handleHeatMapFlow2D(): void {
    this.handleWarehouseControl(
      [IWarehouseControllerType.isHeatMapFlow2DMode],
      [
        IWarehouseControllerType.isSelectionMode,
        IWarehouseControllerType.isDragMode,
      ]
    );
  }

  handleHeatMapPerAddress2D(indicatorName: string): void {
    if (indicatorName === 'None') {
      WarehouseUnityUtils.handleHeatMapPerAddress2D(this.gameInstance, false);
      return;
    }

    this.http.get(`assets/${indicatorName}.json`).subscribe((data) => {
      const json = JSON.stringify(data);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadHeatMapPerAddress2DData',
        json
      );
      this.handleWarehouseControl(
        [],
        [
          IWarehouseControllerType.isSelectionMode,
          IWarehouseControllerType.isDragMode,
        ]
      );
      WarehouseUnityUtils.handleHeatMapPerAddress2D(this.gameInstance, true);
    });
  }

  handleFlyMode(): void {
    this.handleWarehouseControl([IWarehouseControllerType.isFlyMode], []);
  }

  handleHeatMapPerAddress3D(indicatorName: string): void {
    this.handleWarehouseControl(
      [IWarehouseControllerType.isHeatMapPerAddress3DMode],
      []
    );
    if (indicatorName === 'None') {
      this.gameInstance.SendMessage(
        'EventSystem',
        'DisableHeatMapPerAddress3D'
      );
    } else {
      this.gameInstance.SendMessage(
        'EventSystem',
        'LoadHeatMapPerAddress3D',
        indicatorName
      );
    }
  }

  handleMiscellaneous(): void {
    this.handleWarehouseControl(
      [IWarehouseControllerType.isMiscellaneousMode],
      []
    );
    this.gameInstance.SendMessage('JavaScriptMessager', 'ClearMiscellaneous');
    if (!this.warehouseController.isMiscellaneousMode.isEnable) {
      this.http.get('assets/miscellaneousLayout.json').subscribe((data) => {
        const json = JSON.stringify(data);
        this.gameInstance.SendMessage(
          'JavaScriptMessager',
          'LoadMiscellaneous',
          json
        );
      });
    } else {
      this.http
        .get('assets/miscellaneousLayoutParcial.json')
        .subscribe((data) => {
          const json = JSON.stringify(data);
          this.gameInstance.SendMessage(
            'JavaScriptMessager',
            'LoadMiscellaneous',
            json
          );
        });
    }
  }

  handleRemove(): void {
    this.gameInstance.SendMessage('JavaScriptMessager', 'HandleRemove');
  }

  saveAddressToDB(): void {
    this.gameInstance.SendMessage('JavaScriptMessager', 'SaveAddressToDB');
  }

  handleWarehouseControl(enable: string[], disable: string[]): void {
    for (var key in this.warehouseController) {
      if (enable.includes(key)) {
        console.log('b');
        this.warehouseController[key].isEnable = this.warehouseController[key]
          .isEnable
          ? false
          : true;
        this.warehouseController[key].action(
          this.gameInstance,
          this.warehouseController[key].isEnable
        );
      }
      if (disable.includes(key)) {
        this.warehouseController[key].isEnable = false;
        this.warehouseController[key].action(
          this.gameInstance,
          this.warehouseController[key].isEnable
        );
      }
    }
  }
}
