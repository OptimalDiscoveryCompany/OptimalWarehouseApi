import { HttpClient } from '@angular/common/http';
import { Component, Input, OnInit } from '@angular/core';
import { BsModalRef, BsModalService } from 'ngx-bootstrap/modal';
import { IAddress } from 'src/app/shared/models/IAddress';
import { IWarehouseController } from 'src/app/shared/models/IWarehouseController';
import { ModalSelectTypeAddressComponent } from '../modal-select-type-address/modal-select-type-address.component';
import { WarehouseService } from '../warehouse.service';

@Component({
  selector: 'app-warehouse-menu',
  templateUrl: './warehouse-menu.component.html',
  styleUrls: ['./warehouse-menu.component.scss'],
})
export class WarehouseMenuComponent implements OnInit {
  items = ['Address', 'Miscellaneous'];
  expandedIndex = 0;
  bsModalRef!: BsModalRef;

  @Input() gameInstance: any;

  warehouseController: IWarehouseController;

  constructor(
    private warehouseService: WarehouseService,
    private http: HttpClient,
    private modalService: BsModalService
  ) {
    this.warehouseController = {
      isCameraMode: true,
      isDragMode: false,
      isSelectionMode: false,
      isSpawnMode: false,
    };
  }

  ngOnInit(): void {
    if (!window.unityEvents) window.unityEvents = {};
    window.unityEvents.saveEvent = (data: string) => {
      const addresses: IAddress[] = JSON.parse(data);
      addresses.forEach((item) => delete item.id);
      this.warehouseService.saveAddresess(addresses).subscribe();
    };
  }

  load2DAreaPicking(): void {
    this.warehouseService.loadAddresses().subscribe((data) => {
      const json = JSON.stringify(data);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadAddresses',
        json
      );
    });

    this.http.get('assets/miscellaneousLayout.json').subscribe((data) => {
      const json = JSON.stringify(data);
      console.log(json);
      this.gameInstance.SendMessage(
        'JavaScriptMessager',
        'LoadMiscellaneous',
        json
      );
    });
  }

  openModal(): void {
    this.gameInstance.SendMessage(
      'JavaScriptMessager',
      'HandleKeyboard',
      'false'
    );
    this.bsModalRef = this.modalService.show(ModalSelectTypeAddressComponent, {
      class: 'modal-lg',
      initialState: {
        title: 'Area Picking',
        gameInstance: this.gameInstance,
      },
    });


  }

  handleCamera(): void {
    this.warehouseController.isCameraMode =
      !this.warehouseController.isCameraMode;

    this.handleCameraModeGameInstance();
  }

  handleSpawnMode(): void {
    this.warehouseController.isSpawnMode =
      !this.warehouseController.isSpawnMode;

    if (this.warehouseController.isSpawnMode) {
      this.warehouseController.isSelectionMode = false;
      this.warehouseController.isDragMode = false;

      this.handleSelectionModeGameInstance();
      this.handleDragModeGameInstance();
    }

    this.handleSpawnModeGameInstance();
  }

  handleSelectionMode(): void {
    this.warehouseController.isSelectionMode =
      !this.warehouseController.isSelectionMode;

    if (this.warehouseController.isSelectionMode) {
      this.warehouseController.isSpawnMode = false;
      this.warehouseController.isDragMode = false;
      this.warehouseController.isCameraMode = false;

      this.handleDragModeGameInstance();
      this.handleCameraModeGameInstance();
      this.handleSpawnModeGameInstance();
    }

    if (this.warehouseController.isDragMode) {
      this.warehouseController.isDragMode = false;
      this.handleDragModeGameInstance();
    }

    this.handleSelectionModeGameInstance();
  }

  handleDragMode(): void {
    this.warehouseController.isDragMode = !this.warehouseController.isDragMode;

    if (this.warehouseController.isDragMode) {
      this.warehouseController.isCameraMode = false;
      this.warehouseController.isSpawnMode = false;

      this.handleCameraModeGameInstance();
      this.handleSpawnModeGameInstance();
    }

    this.handleDragModeGameInstance();
  }

  handleRemove(): void {
    this.gameInstance.SendMessage('JavaScriptMessager', 'HandleRemove');
  }

  saveAddressToDB(): void {
    this.gameInstance.SendMessage('JavaScriptMessager', 'SaveAddressToDB');
  }

  handleCameraModeGameInstance(): void {
    this.gameInstance.SendMessage(
      'JavaScriptMessager',
      'HandleCamera',
      this.warehouseController.isCameraMode.toString()
    );
  }

  handleDragModeGameInstance(): void {
    this.gameInstance.SendMessage(
      'JavaScriptMessager',
      'HandleDragMode',
      this.warehouseController.isDragMode.toString()
    );
  }

  handleSelectionModeGameInstance(): void {
    this.gameInstance.SendMessage(
      'JavaScriptMessager',
      'HandleSelectionMode',
      this.warehouseController.isSelectionMode.toString()
    );
  }

  handleSpawnModeGameInstance(): void {
    this.gameInstance.SendMessage(
      'JavaScriptMessager',
      'HandleSpawnMode',
      this.warehouseController.isSpawnMode.toString()
    );
  }
}
