import { Component, OnInit, Output, EventEmitter, OnDestroy } from '@angular/core';
import { firstValueFrom } from 'rxjs';
import { IAddress } from 'src/app/shared/models/IAddress';
import { IMiscellaneousType } from 'src/app/shared/models/IMiscellaneous';
import { WarehouseService } from '../warehouse.service';

@Component({
  selector: 'app-warehouse-unity',
  templateUrl: './warehouse-unity.component.html',
  styleUrls: ['./warehouse-unity.component.scss'],
})
export class WarehouseUnityComponent implements OnInit, OnDestroy {
  unityInstance: any;
  isReady = false;
  progress = 0;
  @Output() gameInstanceEvent = new EventEmitter<{ gameInstance: any }>();
  localGameInstance: any;

  @Output() switchMenuEvent = new EventEmitter<{ switchMenu: any }>();
  switchMenu: boolean = false;

  constructor(private warehouseService: WarehouseService) {
    if (!window.unityEvents) window.unityEvents = {};
    window.unityEvents.load3D = async () => {
      const addresses3D: any = await firstValueFrom(
        this.warehouseService.load3dAddresses()
      );

      console.log(addresses3D);
      const miscellaneous: IMiscellaneousType[] = await firstValueFrom(
        this.warehouseService.loadStaticMiscellaneousType()
      );
      const indicators: any = await firstValueFrom(
        this.warehouseService.loadStaticIndicators()
      );
      this.localGameInstance.SendMessage(
        'EventSystem',
        'LoadIndicatorData',
        JSON.stringify(indicators)
      );

      this.localGameInstance.SendMessage(
        'EventSystem',
        'LoadAddress',
        JSON.stringify(addresses3D)
      );

      this.localGameInstance.SendMessage(
        'EventSystem',
        'LoadMiscellaneous',
        JSON.stringify(miscellaneous)
      );
    };
  }
  ngOnDestroy(): void {
    // this.unityInstance.Quit();
    // this.unityInstance = null;
  }

  ngOnInit(): void {
    const loader = (window as any).UnityLoader;
    this.unityInstance = loader.instantiate(
      'unityContainer',
      `assets/build/Build/build.json`,
      {
        onProgress: (gameInstance: any, progress: number) => {
          this.isReady = true;
          this.localGameInstance = gameInstance;
          this.gameInstanceEvent.emit({
            gameInstance: this.localGameInstance,
          });
          this.localGameInstance.SendMessage(
            'JavaScriptMessager',
            'HandleKeyboard',
            'false'
          );
        },
      }
    );

    if (!window.unityEvents) window.unityEvents = {};
    window.unityEvents.saveEvent = (data: string) => {
      const addresses: IAddress[] = JSON.parse(data);
      addresses.forEach((item) => delete item.id);
      this.warehouseService.saveAddresess(addresses).subscribe();
    };
  }

  Load3D(): void {
    this.switchMenu = !this.switchMenu;
    this.switchMenuEvent.emit({
      switchMenu: this.switchMenu,
    });
    if (this.switchMenu) {
      this.localGameInstance.SendMessage('JavaScriptMessager', 'Load3DScene');
    } else {
      this.localGameInstance.SendMessage('EventSystem', 'Load2DScene');
    }
  }
}
