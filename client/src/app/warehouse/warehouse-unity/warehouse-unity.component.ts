import { Component, OnInit, Output, EventEmitter } from '@angular/core';
import { Store } from '@ngrx/store';
import { AppState } from 'src/app/reducer/rootReducer';
import { IAddress } from 'src/app/shared/models/IAddress';
import { SetGameInstance } from '../warehouse-redux/warehouseAction';
import { WarehouseService } from '../warehouse.service';

@Component({
  selector: 'app-warehouse-unity',
  templateUrl: './warehouse-unity.component.html',
  styleUrls: ['./warehouse-unity.component.scss'],
})
export class WarehouseUnityComponent implements OnInit {
  unityInstance: any;
  isReady = false;
  progress = 0;
  @Output() gameInstanceEvent = new EventEmitter<{ gameInstance: any }>();
  localGameInstance: any;

  @Output() switchMenuEvent = new EventEmitter<{ switchMenu: any }>();
  switchMenu: boolean = false;

  constructor(
    private store: Store<AppState>,
    private warehouseService: WarehouseService
  ) {}

  ngOnInit(): void {
    const loader = (window as any).UnityLoader;
    this.unityInstance = loader.instantiate(
      'unityContainer',
      `assets/build/Build/build.json`,
      {
        onProgress: (gameInstance: any, progress: number) => {
          this.isReady = true;
          this.localGameInstance = gameInstance;
          this.gameInstanceEvent.emit({
            gameInstance: this.localGameInstance,
          });
        },
      }
    );

    if (!window.unityEvents) window.unityEvents = {};
    window.unityEvents.saveEvent = (data: string) => {
      const addresses: IAddress[] = JSON.parse(data);
      addresses.forEach((item) => delete item.id);
      this.warehouseService.saveAddresess(addresses).subscribe();
    };
  }

  Load3D(): void {
    this.switchMenu = !this.switchMenu;
    this.switchMenuEvent.emit({
      switchMenu: this.switchMenu,
    });  
  }
}
