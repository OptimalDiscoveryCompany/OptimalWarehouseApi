import { HttpClient, HttpParams } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable, of } from 'rxjs';
import { environment } from 'src/environments/environment';
import { IAddress } from '../shared/models/IAddress';
import { IAddress3D } from '../shared/models/IAddress3D';
import { IMiscellaneousType } from '../shared/models/IMiscellaneous';
import { IPathReturn } from '../shared/models/IPathReturn';
import { IPositionTypeBin } from '../shared/models/IPositionTypeBin';
import * as dateFormat from 'dateformat';
import {
  IAddressDetail,
  IProductBinDetail,
} from '../shared/models/IAddressDetail';
import { Store } from '@ngrx/store';
import { AppState } from '../reducer/rootReducer';
import { SetAddresses } from './warehouse-redux/warehouseAction';
import { IScenarioChanges } from '../shared/models/ICompare';

@Injectable({
  providedIn: 'root',
})
export class WarehouseService {
  baseUrl = environment.rpwebAPI;

  constructor(private http: HttpClient, private store: Store<AppState>) {}

  loadPositionTypeBins(): Observable<IPositionTypeBin[]> {
    return this.http.get<IPositionTypeBin[]>(
      `${this.baseUrl}/PositionTypeMaster`
    );
  }

  loadMiscellaneousType(): Observable<IMiscellaneousType> {
    return this.http.get<IMiscellaneousType>(`${this.baseUrl}/miscellaneous`);
  }

  loadAddresses(scenarioName: string) {
    this.http
      .get<IAddress[]>(`${this.baseUrl}/address`, {
        params: new HttpParams().append('scenarioName', scenarioName),
      })
      .subscribe((data) => {
        this.store.dispatch(SetAddresses(data));
      });
  }

  load3dAddresses(): Observable<IAddress3D[]> {
    return this.http.get<IAddress3D[]>(`${this.baseUrl}/address/address3d`);
  }

  loadHeatMapFlow2D(start: Date, end: Date): Observable<IPathReturn[]> {
    const params = new HttpParams()
      .set('start', dateFormat.default(start, 'yyyy-mm-dd'))
      .set('end', dateFormat.default(end, 'yyyy-mm-dd'));

    return this.http.get<IPathReturn[]>(`${this.baseUrl}/point`, {
      params: params,
    });
  }

  loadAddressDetail(id: number): Observable<IAddressDetail> {
    return this.http.get<IAddressDetail>(
      `${this.baseUrl}/address/addressdetail/${id}`
    );
  }

  loadProducts(): Observable<IProductBinDetail[]> {
    return this.http.get<IProductBinDetail[]>(`${this.baseUrl}/product`);
  }

  loadScenariosChanges(scenarioName: string): Observable<IScenarioChanges[]> {
    return this.http.get<IScenarioChanges[]>(
      `${this.baseUrl}/scenario/scenarioname`,
      { params: new HttpParams().append('scenarioName', scenarioName) }
    );
  }

  saveAddresess(addresses: IAddress[]) {
    return this.http.post(`${this.baseUrl}/address`, addresses);
  }

  saveAddressDetail(id: number, address: IAddressDetail) {
    return this.http.post(
      `${this.baseUrl}/address/addressDetail/${id}`,
      address
    );
  }

  //demo
  loadStaticMiscellaneousType(): Observable<IMiscellaneousType[]> {
    return this.http.get<any>(`/assets/miscellaneousLayout.json`);
  }

  loadStatic2dAddresses(): Observable<IAddress[]> {
    return this.http.get<any>(`/assets/addressLayout.json`);
  }

  loadStaticIndicators(): Observable<any> {
    return this.http.get<any>(`/assets/indicatorData.json`);
  }
}
