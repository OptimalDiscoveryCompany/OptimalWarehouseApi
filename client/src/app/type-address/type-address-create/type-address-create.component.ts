import { Component, OnInit } from '@angular/core';
import {
  FormBuilder,
  FormControl,
  FormGroup,
  Validators,
} from '@angular/forms';
import { IBin } from 'src/app/shared/models/IBin';
import { ILayer } from 'src/app/shared/models/ILayer';
import { v4 as uuidv4 } from 'uuid';

@Component({
  selector: 'app-type-address-create',
  templateUrl: './type-address-create.component.html',
  styleUrls: ['./type-address-create.component.scss'],
})
export class TypeAddressCreateComponent implements OnInit {
  layers: ILayer[] = [];
  bins: IBin[] = [];

  actualLayerCount = 0;
  actualBinCount = 0;

  typeForm!: FormGroup;
  selectedType: string = 'floor';

  gameInstance: any;

  constructor() {}

  ngOnInit(): void {
    this.initForm();
  }

  submit(): void {}

  initForm(): void {
    this.typeForm = new FormGroup({
      type: new FormControl(this.selectedType, [Validators.required]),
      description: new FormControl('', [Validators.required]),
      totalFront: new FormControl('1.0', [Validators.required]),
      totalDepth: new FormControl('1.0', [Validators.required]),
      totalHeight: new FormControl('1.0', [Validators.required]),
      color: new FormControl('#000000', [Validators.required]),
    });

    this.typeForm.get('type')?.valueChanges.subscribe((value) => {
      this.selectedType = value;
      this.gameInstance.SendMessage(
        'EventManager',
        'SelectPositionTypePrefab',
        this.selectedType
      );
    });

    this.typeForm.get('totalHeight')?.valueChanges.subscribe((value) => {
      const height = {
        axis: 1,
        amount: value,
      };

      this.gameInstance.SendMessage(
        'EventManager',
        'HandleResizeVisualization',
        JSON.stringify(height)
      );
    });
  }

  onLevelValueChange(value: number): void {
    this.layers = [];

    const totalFront = parseFloat(this.typeForm.get('totalFront')?.value);
    const totalDepth = parseFloat(this.typeForm.get('totalDepth')?.value);
    const totalHeight = parseFloat(this.typeForm.get('totalHeight')?.value);

    const height = totalHeight / value;
    let y = 0;

    for (let i = 0; i < value; i++) {
      this.layers.push({
        bins: [],
        layerDescription: `L${i}`,
        locationX: 0.0,
        locationY: y,
        locationZ: 0.0,
        totalDepth,
        totalFront,
        totalHeight: height,
        uuid: uuidv4(),
      });

      this.gameInstance.SendMessage('EventManager', 'AddLayer', y.toString());
      y += height;
    }
  }

  setLayerHeight(id: string, event: any): void {
    const index = this.layers.findIndex((x) => x.uuid! === id);
    const layer = this.layers[index];
    layer.totalHeight = parseFloat(event.target.value);

    let locationY = 0.0;

    for (let i = 0; i < index; i++) {
      const item = this.layers[i];
      locationY += item.locationY + item.totalHeight;
    }
    layer.locationY = locationY;
    locationY += layer.totalHeight;
    const totalHeight = parseFloat(this.typeForm.get('totalHeight')?.value);
    const height = (totalHeight - locationY) / (this.layers.length - 1 - index);

    for (let i = index + 1; i < this.layers.length; i++) {
      const item = this.layers[i];
      item.locationY = locationY;
      item.totalHeight = height;
      locationY += height;
    }
  }

  onBinValueChange(value: number): void {
    this.bins = [];

    const totalFront = parseFloat(this.typeForm.get('totalFront')?.value);
    const totalDepth = parseFloat(this.typeForm.get('totalDepth')?.value);

    const front = totalFront / value;
    let x = 0.0;

    for (let i = 0; i < value; i++) {
      this.bins.push({
        totalHeight: 0.05,
        totalFront: front,
        totalDepth,
        binDescription: `B${i}`,
        angle: 0.0,
        images: [],
        products: [],
        locationX: x,
        locationY: 0.0,
        locationZ: 0.0,
        uuid: uuidv4(),
      });

      x += front;
    }
  }

  setBinFront(id: string, event: any): void {
    const index = this.bins.findIndex((x) => x.uuid! === id);
    const bin = this.bins[index];
    bin.totalFront = parseFloat(event.target.value);

    let locationX = 0.0;

    for (let i = 0; i < index; i++) {
      const item = this.bins[i];
      locationX += item.locationX + item.totalFront;
    }
    bin.locationX = locationX;
    locationX += bin.totalFront;
    const totalFront = parseFloat(this.typeForm.get('totalFront')?.value);
    const front = (totalFront - locationX) / (this.bins.length - 1 - index);

    for (let i = index + 1; i < this.bins.length; i++) {
      const item = this.bins[i];
      item.locationX = locationX;
      item.totalFront = front;
      locationX += front;
    }
  }

  setGameInstance(event: { gameInstance: any }): void {
    this.gameInstance = event.gameInstance;
  }
}
