import { Component, Input, OnInit } from '@angular/core';
import { FormGroup } from '@angular/forms';
import { IDropdown } from 'src/app/shared/models/IDropdown';
import { ILayer } from 'src/app/shared/models/ILayer';

@Component({
  selector: 'app-type-address-layer',
  templateUrl: './type-address-layer.component.html',
  styleUrls: ['./type-address-layer.component.scss'],
})
export class TypeAddressLayerComponent implements OnInit {

  @Input() typeForm!: FormGroup;

  layerDropdown: IDropdown[] = [];
  selectedLayer: ILayer | undefined = undefined;
  layers: ILayer[] = [];
  layerIndexName = 1;

  constructor() {}

  ngOnInit(): void {}




  addLayer(): void {
    let locationY = 0;

    const lastLayer: ILayer = this.layers.slice[-1];
    if (lastLayer) {
      locationY = lastLayer.locationY + lastLayer.totalHeight;
    }

    let front = parseFloat(this.typeForm.get('totalFront')?.value);
    if (Number.isNaN(front)) {
      front = 0;
    }

    let totalHeight =
      Math.abs(parseFloat(this.typeForm.get('totalHeight')?.value)) /
      (this.layers.length + 1);

    this.recalculateSizeOfEachLayer(totalHeight);

    const layer: ILayer = {
      layerName: `L${this.layerIndexName++}`,
      locationX: 0,
      locationY: locationY,
      locationZ: 0,
      totalDepth: 0,
      bins: [],
      totalFront: front,
      totalHeight: totalHeight,
    };

    this.layers.push(layer);
    this.layerDropdown.push({
      text: layer.layerName,
      value: layer.layerName,
    });
  }

  removeLayer(): void {
    const layerName = this.typeForm.get('layerDropdown')?.value;
    if (layerName) {
      this.layers.splice(
        this.layers.findIndex((x) => x.layerName === layerName),
        1
      );
      this.layerDropdown.splice(
        this.layerDropdown.findIndex((x) => x.value === layerName),
        1
      );
    }
  }

  getDivLayerSize(totalHeightLayer: number, totalHeight: number): number {
    const res = (500 * totalHeightLayer) / totalHeight;
    return res;
  }

  get totalHeight(): number {
    return parseFloat(this.typeForm.get('totalHeight')?.value);
  }

  private recalculateSizeOfEachLayer(newHeight: number): void {
    this.layers.forEach((item) => {
      item.totalHeight = newHeight;
    });
  }

  onLayerSelect(layerName: string) {
    const layer = this.layers.find((it) => it.layerName === layerName);
    if (layer) {
      this.typeForm.get('totalHeightLayer')?.setValue(layer.totalHeight);
      this.typeForm.get('layerName')?.setValue(layer.layerName);
      this.typeForm.get('layerDropdown')?.setValue(layer.layerName);
    }
  }
}
