import { Component, OnInit } from '@angular/core';
import {
  FormBuilder,
  FormControl,
  FormGroup,
  Validators,
} from '@angular/forms';
import { Toast, ToastrService } from 'ngx-toastr';
import { IDropdown } from 'src/app/shared/models/IDropdown';
import { ILayer } from 'src/app/shared/models/ILayer';
import {
  IPositionTypeBin,
  IPositionTypeMaster,
} from 'src/app/shared/models/IPositionTypeBin';
import { IResize } from 'src/app/shared/models/IResize';
import { TypeAddressService } from '../type-address.service';

@Component({
  selector: 'app-type-address-accordion',
  templateUrl: './type-address-accordion.component.html',
  styleUrls: ['./type-address-accordion.component.scss'],
})
export class TypeAddressAccordionComponent implements OnInit {
  typeForm!: FormGroup;

  type: IDropdown[] = [
    {
      text: 'Floor',
      value: 'floor',
    },
    {
      text: 'Bin',
      value: 'bin',
    },
    {
      text: 'Rack',
      value: 'rack',
    },
  ];

  isFloor = true;
  selectedType: string = 'floor';
  colorInHex = '#000000';

  gameInstance: any;

  constructor(
    private typeAddressService: TypeAddressService,
    private toastr: ToastrService,
    private fb: FormBuilder
  ) {}

  ngOnInit(): void {
    this.initForm();
  }

  initForm(): void {
    this.typeForm = this.fb.group({
      addressPostionTypeForm: this.fb.group({
        type: [this.selectedType, Validators.nullValidator],
        positionTypeDescription: ['', Validators.nullValidator],
        totalHeight: ['1.0', Validators.nullValidator],
        totalFront: ['1.0', Validators.nullValidator],
        totalDepth: ['1.0', Validators.nullValidator],
        positionColor: ['', Validators.nullValidator],
      }),
      layerForm: this.fb.group({
        layerDropdown: ['', Validators.nullValidator],
        layerName: ['', Validators.nullValidator],
        totalHeightLayer: ['0.0', Validators.nullValidator],
        locationHeight: ['0.0', Validators.nullValidator],
      }),
    });

    this.typeForm
      .get('addressPostionTypeForm')
      ?.get('positionColor')
      ?.valueChanges.subscribe((value) => {
        this.colorInHex = value;
      });
  }

  onSubmit(): void {
    const value = this.typeForm.value as IPositionTypeMaster;
    this.typeAddressService.savePositionType(value).subscribe();
  }

  setGameInstance(event: { gameInstance: any }) {
    this.gameInstance = event.gameInstance;
    this.setObserversToInputs();
  }

  setObserversToInputs(): void {
    this.typeForm
      .get('addressPostionTypeForm')
      ?.get('type')
      ?.valueChanges.subscribe((value) => {
        if (value !== 'floor') this.isFloor = false;
        else this.isFloor = true;

        this.gameInstance.SendMessage(
          'EventManager',
          'SelectPositionTypePrefab',
          value
        );

        this.typeForm
          .get('addressPostionTypeForm')
          ?.get('totalHeight')
          ?.reset('1.0');
        this.typeForm
          .get('addressPostionTypeForm')
          ?.get('totalFront')
          ?.reset('1.0');
        this.typeForm
          .get('addressPostionTypeForm')
          ?.get('totalDepth')
          ?.reset('1.0');
      });
    const resize: IResize = {
      amount: 1.0,
      axis: 0,
    };

    this.typeForm
      .get('addressPostionTypeForm')
      ?.get('totalHeight')
      ?.valueChanges.subscribe((value) => {
        resize.axis = 1;
        resize.amount = parseFloat(value);
        this.gameInstance.SendMessage(
          'EventManager',
          'HandleResizeVisualization',
          JSON.stringify(resize)
        );
      });

    this.typeForm
      .get('addressPostionTypeForm')
      ?.get('totalFront')
      ?.valueChanges.subscribe((value) => {
        resize.axis = 0;
        resize.amount = parseFloat(value);
        this.gameInstance.SendMessage(
          'EventManager',
          'HandleResizeVisualization',
          JSON.stringify(resize)
        );
      });

    this.typeForm
      .get('addressPostionTypeForm')
      ?.get('totalDepth')
      ?.valueChanges.subscribe((value) => {
        resize.axis = 2;
        resize.amount = parseFloat(value);
        this.gameInstance.SendMessage(
          'EventManager',
          'HandleResizeVisualization',
          JSON.stringify(resize)
        );
      });
  }
}
