import { Component, OnInit } from '@angular/core';
import {
  FormBuilder,
  FormControl,
  FormGroup,
  Validators,
} from '@angular/forms';
import { Toast, ToastrService } from 'ngx-toastr';
import { IBin } from 'src/app/shared/models/IBin';
import { IDropdown } from 'src/app/shared/models/IDropdown';
import { ILayer } from 'src/app/shared/models/ILayer';
import {
  IPositionTypeBin,
  IPositionTypeMaster,
} from 'src/app/shared/models/IPositionTypeBin';
import { IResize } from 'src/app/shared/models/IResize';
import { ITypeForm } from 'src/app/shared/models/ITypeForm';
import { TypeAddressService } from '../type-address.service';

@Component({
  selector: 'app-type-address-accordion',
  templateUrl: './type-address-accordion.component.html',
  styleUrls: ['./type-address-accordion.component.scss'],
})
export class TypeAddressAccordionComponent implements OnInit {
  typeForm!: FormGroup;

  type: IDropdown[] = [
    {
      text: 'Floor',
      value: 'floor',
    },
    {
      text: 'Bin',
      value: 'bin',
    },
    {
      text: 'Rack',
      value: 'rack',
    },
  ];

  isFloor = true;
  selectedType: string = 'floor';
  colorInHex = '#000000';

  layers: ILayer[] = [];
  layersDropdown: IDropdown[] = [];

  bins: IBin[] = [];

  gameInstance: any;

  constructor(
    private typeAddressService: TypeAddressService,
    private toastr: ToastrService,
    private fb: FormBuilder
  ) {}

  ngOnInit(): void {
    this.initForm();
  }

  initForm(): void {
    this.typeForm = this.fb.group({
      addressPostionTypeForm: this.fb.group({
        type: [this.selectedType, Validators.nullValidator],
        positionTypeDescription: ['', Validators.nullValidator],
        totalHeight: ['1.0', Validators.nullValidator],
        totalFront: ['1.0', Validators.nullValidator],
        totalDepth: ['1.0', Validators.nullValidator],
        positionColor: ['#000000', Validators.nullValidator],
      }),
      layerForm: this.fb.group({
        layerDropdown: ['', Validators.nullValidator],
        layerDescription: ['', Validators.nullValidator],
        totalHeightLayer: ['0.0', Validators.nullValidator],
        locationY: ['0.0', Validators.nullValidator],
      }),
      binForm: this.fb.group({
        layerDropdownBin: ['', Validators.nullValidator],
        binDropdown: ['', Validators.nullValidator],
        binDescription: ['', Validators.nullValidator],
        angle: ['0.0', Validators.nullValidator],
        totalHeight: ['0.0', Validators.nullValidator],
        totalFront: ['0.0', Validators.nullValidator],
        locationX: ['0.0', Validators.nullValidator],
      }),
    });

    this.typeForm
      .get('addressPostionTypeForm')
      ?.get('positionColor')
      ?.valueChanges.subscribe((value) => {
        this.colorInHex = value;
      });
  }

  onSubmit(): void {
    const value = this.typeForm.value as ITypeForm;
    const positionType: IPositionTypeMaster = {
      type: value.addressPostionTypeForm.type,
      totalDepth: value.addressPostionTypeForm.totalDepth,
      totalFront: value.addressPostionTypeForm.totalFront,
      totalHeight: value.addressPostionTypeForm.totalHeight,
      positionColor: parseInt(
        value.addressPostionTypeForm.positionColor.replace('#', ''),
        16
      ),
      positionTypeDescription:
        value.addressPostionTypeForm.positionTypeDescription,
      layers: this.layers,
    };

    if (positionType.type === 'floor')
      this.generateLayerAndBinToFloorPositions(positionType);

    console.log(positionType);
    this.typeAddressService.savePositionType(positionType).subscribe();
  }

  private generateLayerAndBinToFloorPositions(
    positionType: IPositionTypeMaster
  ) {
    positionType.layers = [
      {
        layerDescription: 'L01',
        totalFront: positionType.totalFront,
        totalHeight: positionType.totalHeight,
        totalDepth: positionType.totalDepth,
        locationX: 0,
        locationY: 0,
        locationZ: 0,
        bins: [
          {
            binDescription: 'B01',
            totalFront: 1,
            totalHeight: 1.3,
            totalDepth: 1.2,
            angle: 0,
            locationX: 0,
            locationY: 0,
            locationZ: 0,
            images: [],
            products: [],
          },
        ],
      },
    ];
  }

  setGameInstance(event: { gameInstance: any }) {
    this.gameInstance = event.gameInstance;
    this.setObserversToInputs();
  }

  setObserversToInputs(): void {
    this.typeForm
      .get('addressPostionTypeForm')
      ?.get('type')
      ?.valueChanges.subscribe((value) => {
        if (value !== 'floor') this.isFloor = false;
        else this.isFloor = true;

        this.gameInstance.SendMessage(
          'EventManager',
          'SelectPositionTypePrefab',
          value
        );

        this.typeForm
          .get('addressPostionTypeForm')
          ?.get('totalHeight')
          ?.reset('1.0');
        this.typeForm
          .get('addressPostionTypeForm')
          ?.get('totalFront')
          ?.reset('1.0');
        this.typeForm
          .get('addressPostionTypeForm')
          ?.get('totalDepth')
          ?.reset('1.0');
      });
    const resize: IResize = {
      amount: 1.0,
      axis: 0,
    };

    this.typeForm
      .get('addressPostionTypeForm')
      ?.get('totalHeight')
      ?.valueChanges.subscribe((value) => {
        resize.axis = 1;
        resize.amount = parseFloat(value);
        this.gameInstance.SendMessage(
          'EventManager',
          'HandleResizeVisualization',
          JSON.stringify(resize)
        );
      });

    this.typeForm
      .get('addressPostionTypeForm')
      ?.get('totalFront')
      ?.valueChanges.subscribe((value) => {
        resize.axis = 0;
        resize.amount = parseFloat(value);
        this.gameInstance.SendMessage(
          'EventManager',
          'HandleResizeVisualization',
          JSON.stringify(resize)
        );
      });

    this.typeForm
      .get('addressPostionTypeForm')
      ?.get('totalDepth')
      ?.valueChanges.subscribe((value) => {
        resize.axis = 2;
        resize.amount = parseFloat(value);
        this.gameInstance.SendMessage(
          'EventManager',
          'HandleResizeVisualization',
          JSON.stringify(resize)
        );
      });
  }

  setLayers(event: { layers: ILayer[] }): void {
    this.layers = event.layers;
  }
  setBins(event: { bins: IBin[] }): void {
    this.bins = event.bins;
  }
  setLayersDropdown(event: { layersDropdown: IDropdown[] }) {
    this.layersDropdown = event.layersDropdown;
  }
}
