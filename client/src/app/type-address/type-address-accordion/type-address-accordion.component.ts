import {
  Component,
  Input,
  OnInit,
  Output,
  EventEmitter,
  ViewChild,
  ElementRef,
} from '@angular/core';
import { FormControl, FormGroup, Validators } from '@angular/forms';
import { IDropdown } from 'src/app/shared/models/IDropdown';
import {
  IPositionTypeBin,
  IPositionTypeMaster,
} from 'src/app/shared/models/IPositionTypeBin';
import { IResize } from 'src/app/shared/models/IResize';
import { TypeAddressService } from '../type-address.service';

@Component({
  selector: 'app-type-address-accordion',
  templateUrl: './type-address-accordion.component.html',
  styleUrls: ['./type-address-accordion.component.scss'],
})
export class TypeAddressAccordionComponent implements OnInit {
  typeForm!: FormGroup;

  type: IDropdown[] = [
    {
      text: 'Floor',
      value: 'floor',
    },
    {
      text: 'Bin',
      value: 'bin',
    },
    {
      text: 'Rack',
      value: 'rack',
    },
  ];
  isFloor = true;
  selectedType: string = 'floor';
  colorInHex = '#000000';

  gameInstance: any;

  constructor(private typeAddressService: TypeAddressService) {}

  ngOnInit(): void {
    this.initForm();
  }

  initForm(): void {
    this.typeForm = new FormGroup({
      type: new FormControl(this.selectedType, []),
      positionTypeDescription: new FormControl('', []),
      totalHeight: new FormControl('1.0', []),
      totalFront: new FormControl('1.0', []),
      totalDepth: new FormControl('1.0', []),
      positionColor: new FormControl('', []),
    });

    this.typeForm.get('positionColor')?.valueChanges.subscribe((value) => {
      this.colorInHex = value;
    });
  }

  onSubmit(): void {
    const value = this.typeForm.value as IPositionTypeMaster;
    this.typeAddressService.savePositionType(value).subscribe();
  }

  setGameInstance(event: { gameInstance: any }) {
    this.gameInstance = event.gameInstance;
    this.setObserversToInputs();
  }

  setObserversToInputs(): void {
    this.typeForm.get('type')?.valueChanges.subscribe((value) => {
      if (value !== 'floor') this.isFloor = false;
      else this.isFloor = true;

      this.gameInstance.SendMessage(
        'EventManager',
        'SelectPositionTypePrefab',
        value
      );
    });
    const resize: IResize = {
      amount: 1.0,
      axis: 0,
    };

    this.typeForm.get('totalHeight')?.valueChanges.subscribe((value) => {
      resize.axis = 1;
      resize.amount = parseFloat(value);
      this.gameInstance.SendMessage(
        'EventManager',
        'HandleResizeVisualization',
        JSON.stringify(resize)
      );
    });

    this.typeForm.get('totalWidth')?.valueChanges.subscribe((value) => {
      resize.axis = 0;
      resize.amount = parseFloat(value);
      this.gameInstance.SendMessage(
        'EventManager',
        'HandleResizeVisualization',
        JSON.stringify(resize)
      );
    });

    this.typeForm.get('totalDepth')?.valueChanges.subscribe((value) => {
      resize.axis = 2;
      resize.amount = parseFloat(value);
      this.gameInstance.SendMessage(
        'EventManager',
        'HandleResizeVisualization',
        JSON.stringify(resize)
      );
    });
  }
}
