import { Component, OnInit } from '@angular/core';
import { FormControl, FormGroup, Validators } from '@angular/forms';
import { Toast, ToastrService } from 'ngx-toastr';
import { IDropdown } from 'src/app/shared/models/IDropdown';
import { ILayer } from 'src/app/shared/models/ILayer';
import {
  IPositionTypeBin,
  IPositionTypeMaster,
} from 'src/app/shared/models/IPositionTypeBin';
import { IResize } from 'src/app/shared/models/IResize';
import { TypeAddressService } from '../type-address.service';

@Component({
  selector: 'app-type-address-accordion',
  templateUrl: './type-address-accordion.component.html',
  styleUrls: ['./type-address-accordion.component.scss'],
})
export class TypeAddressAccordionComponent implements OnInit {
  typeForm!: FormGroup;

  type: IDropdown[] = [
    {
      text: 'Floor',
      value: 'floor',
    },
    {
      text: 'Bin',
      value: 'bin',
    },
    {
      text: 'Rack',
      value: 'rack',
    },
  ];

  isFloor = true;
  selectedType: string = 'floor';
  colorInHex = '#000000';

  layerDropdown: IDropdown[] = [];
  selectedLayer: ILayer | undefined = undefined;
  layers: ILayer[] = [];
  layerIndexName = 1;

  gameInstance: any;

  constructor(
    private typeAddressService: TypeAddressService,
    private toastr: ToastrService
  ) {}

  ngOnInit(): void {
    this.initForm();
  }

  initForm(): void {
    this.typeForm = new FormGroup({
      type: new FormControl(this.selectedType, []),
      positionTypeDescription: new FormControl('', []),
      totalHeight: new FormControl('1.0', []),
      totalFront: new FormControl('1.0', []),
      totalDepth: new FormControl('1.0', []),
      positionColor: new FormControl('', []),
      layerDropdown: new FormControl('', []),
      layerName: new FormControl('', []),
      totalHeightLayer: new FormControl('0.0', []),
    });

    this.typeForm.get('positionColor')?.valueChanges.subscribe((value) => {
      this.colorInHex = value;
    });
  }

  onSubmit(): void {
    const value = this.typeForm.value as IPositionTypeMaster;
    this.typeAddressService.savePositionType(value).subscribe();
  }

  setGameInstance(event: { gameInstance: any }) {
    this.gameInstance = event.gameInstance;
    this.setObserversToInputs();
  }

  setObserversToInputs(): void {
    this.typeForm.get('type')?.valueChanges.subscribe((value) => {
      if (value !== 'floor') this.isFloor = false;
      else this.isFloor = true;

      this.gameInstance.SendMessage(
        'EventManager',
        'SelectPositionTypePrefab',
        value
      );

      this.typeForm.get('totalHeight')?.reset('1.0');
      this.typeForm.get('totalFront')?.reset('1.0');
      this.typeForm.get('totalDepth')?.reset('1.0');
    });
    const resize: IResize = {
      amount: 1.0,
      axis: 0,
    };

    this.typeForm.get('totalHeight')?.valueChanges.subscribe((value) => {
      resize.axis = 1;
      resize.amount = parseFloat(value);
      this.gameInstance.SendMessage(
        'EventManager',
        'HandleResizeVisualization',
        JSON.stringify(resize)
      );
    });

    this.typeForm.get('totalFront')?.valueChanges.subscribe((value) => {
      resize.axis = 0;
      resize.amount = parseFloat(value);
      this.gameInstance.SendMessage(
        'EventManager',
        'HandleResizeVisualization',
        JSON.stringify(resize)
      );
    });

    this.typeForm.get('totalDepth')?.valueChanges.subscribe((value) => {
      resize.axis = 2;
      resize.amount = parseFloat(value);
      this.gameInstance.SendMessage(
        'EventManager',
        'HandleResizeVisualization',
        JSON.stringify(resize)
      );
    });
  }

  addLayer(): void {
    let locationY = 0;

    const lastLayer: ILayer = this.layers.slice[-1];
    if (lastLayer) {
      locationY = lastLayer.locationY + lastLayer.totalHeight;
    }

    let front = parseFloat(this.typeForm.get('totalFront')?.value);
    if (Number.isNaN(front)) {
      front = 0;
    }

    let positionTotalheight =
      Math.abs(parseFloat(this.typeForm.get('totalHeight')?.value)) /
      (this.layers.length + 1);

    console.log(
      parseFloat(this.typeForm.get('totalHeight')?.value),
      this.typeForm.get('totalHeight')?.value,
      this.layers.length + 1,
      positionTotalheight
    );

    const layer: ILayer = {
      layerName: `L${this.layerIndexName++}`,
      locationX: 0,
      locationY: locationY,
      locationZ: 0,
      totalDepth: 0,
      bins: [],
      totalFront: front,
      totalHeight: positionTotalheight,
    };

    this.layers.push(layer);
    this.layerDropdown.push({
      text: layer.layerName,
      value: layer.layerName,
    });
  }

  removeLayer(): void {
    const layerName = this.typeForm.get('layerDropdown')?.value;
    if (layerName) {
      this.layers.splice(
        this.layers.findIndex((x) => x.layerName === layerName),
        1
      );
      this.layerDropdown.splice(
        this.layerDropdown.findIndex((x) => x.value === layerName),
        1
      );
    }
  }

  getDivLayerSize(totalHeight: number): number {
    const res = (500 * totalHeight * 100) / 100;
    return res;
  }
}
