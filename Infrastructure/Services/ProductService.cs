using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Core.Dtos.Address;
using Core.Entities;
using Core.Interfaces;
using Core.Interfaces.Services;
using Dapper;
using Infrastructure.Data;
using Infrastructure.ORMClass;
using Microsoft.EntityFrameworkCore;

namespace Infrastructure.Services
{
    public class ProductService : IProductService
    {
        private readonly StoreContext _storeContext;

        public ProductService(StoreContext storeContext)
        {
            _storeContext = storeContext;
        }

        public async Task<IReadOnlyList<ProductBinDto>> ListAllProductsAsync()
        {

            var products = new List<ProductBinDto>();
            var conn = _storeContext.Database.GetDbConnection();

            var result = await conn.QueryAsync<ProductORM>(@"
                    SELECT 
                        TPM.PRODUCT_ID as ProductId, 
                        TPM.PRODUCT_DESCRIPTION_LONG as ProductDescription,
                        TPM1.PACKAGE_SMALLER_SIDE as TotalFront  ,
                        TPM1.PACKAGE_LARGER_SIDE as TotalDepth,
                        TPM1.PACKAGE_HEIGHT as TotalHeight,
                        TPM2.PALLET_FRONT as PalletFront,
                        TPM2.PALLET_HEIGHT as PalletHeight,
                        TPM2.PALLET_SIDE as PalletDepth
                    FROM T_PRODUCT_MASTER TPM
                    LEFT JOIN T_PACKAGE_MASTER TPM1 ON TPM1.PACKAGE_ID = TPM.PACKAGE_ID
                    LEFT JOIN T_PALLET_MASTER TPM2 ON TPM2.PACKAGE_ID = TPM.PACKAGE_ID");

            foreach (var res in result)
            {
                var imageFrontBack = new AddressImage3D
                {
                    Filename = $"/{res.ProductId}F.jpg",
                    Height = 200,
                    Width = 200,
                };
                var imageDepth = new AddressImage3D
                {
                    Filename = $"/{res.ProductId}L.jpg",
                    Height = 200,
                    Width = 200,
                };

                var imageTopBottom = new AddressImage3D
                {
                    Filename = $"/{res.ProductId}S.jpg",
                    Height = 200,
                    Width = 200,
                };

                var palletImageFrontBack = new AddressImage3D
                {
                    Filename = $"/COMBINED/PF/{res.ProductId}.jpg",
                    Width = 200,
                    Height = 200,
                };

                var palletImageDepth = new AddressImage3D
                {
                    Filename = $"/COMBINED/PL/{res.ProductId}.jpg",
                    Width = 200,
                    Height = 200,
                };

                var palletTopBottom = new AddressImage3D
                {
                    Filename = $"/COMBINED/PT/{res.ProductId}.jpg",
                    Width = 200,
                    Height = 200,
                };


                products.Add(new ProductBinDto
                {
                    Images = new List<AddressImage3D>
                        {
                            //package image
                            imageFrontBack,
                            imageFrontBack,
                            imageDepth,
                            imageDepth,
                            imageTopBottom,
                            imageTopBottom,
                            // pallet image
                            palletImageFrontBack,
                            palletImageFrontBack,
                            palletImageDepth,
                            palletImageDepth,
                            palletTopBottom,
                            palletTopBottom
                        },
                    PalletDepth = res.PalletDepth,
                    PalletFront = res.PalletFront,
                    PalletHeight = res.PalletHeight,
                    ProductDescription = res.ProductDescription,
                    ProductId = res.ProductId,
                    TotalDepth = res.TotalDepth,
                    TotalFront = res.TotalFront,
                    TotalHeight = res.TotalHeight
                });
            }




            return products;
        }
    }
}