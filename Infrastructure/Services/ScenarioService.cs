using Core.Dtos.Address;
using Core.Dtos.Scenario;
using Core.Entities;
using Core.Interfaces;
using Core.Interfaces.Services;
using Core.Specification.AddressSpecification;
using Core.Specification.ScenarioSpecification;
using Infrastructure.ORMClass;
using Newtonsoft.Json;

namespace Infrastructure.Services
{
    public class ScenarioService : IScenarioService
    {
        private readonly IUnitOfWork _unitOfWork;
        private readonly IProductService _productService;

        public ScenarioService(IUnitOfWork unitOfWork, IProductService productService)
        {
            _unitOfWork = unitOfWork;
            _productService = productService;
        }

        public async Task<bool> AddEditScenarioAsync(ScenarioDto scenarioDto)
        {
            var foundScenario = await _unitOfWork.Repository<TScenarioMaster>().GetEntityWithSpecs(new ScenarioWithIncludesSpecification(scenarioDto.Id));
            if (foundScenario != null)
            {
                _unitOfWork.Repository<TScenarioMaster>().Delete(foundScenario);
                await _unitOfWork.Complete();
            }

            var criterias = new List<TScenarioCriteria>();
            foreach (var criteria in scenarioDto.Criterias)
            {
                criterias.Add(new TScenarioCriteria
                {
                    CriteriaType = criteria.CriteriaType,
                    Id = criteria.Id,
                    ModifierType = criteria.ModifierType,
                    ModifierValue = criteria.ModifierValue,
                    PackagesGroup = string.Join(',', criteria.PackagesGroup),
                    Product = string.Join(',', criteria.Product),
                    ProductType = string.Join(',', criteria.ProductType),
                });
            }

            var scenario = new TScenarioMaster
            {
                Criterias = criterias,
                Id = scenarioDto.Id,
                ScenarioName = scenarioDto.ScenarioName,
                Shifts = string.Join(',', scenarioDto.Shifts),
                Timeframe = scenarioDto.Timeframe
            };

            _unitOfWork.Repository<TScenarioMaster>().Add(scenario);

            var scenarioChanges = ReadJsonFile("changeProducts.json");
            var scenarioChangesSave = new List<TScenarioChanges>();
            scenarioChanges.ForEach(sc =>
            {
                scenarioChangesSave.Add(new TScenarioChanges
                {
                    ScenarioName = scenarioDto.ScenarioName,
                    AddressIdDestiny = sc.AddressIdDestiny,
                    AddressIdOrigin = sc.AddressIdOrigin,
                    ProductId = sc.ProductId
                });
            });

            var products = await _productService.ListAllProductsAsync();
            var addresses = await _unitOfWork.Repository<TPickingAddressMaster>().ListAsync(new AddressWithIncludes("Actual"));

            //create a copy of the actual area picking to create scenario and set ids to null and set products 
            foreach (var address in addresses)
            {
                address.PickingAreaDescription = scenarioDto.ScenarioName;
                address.Id = 0;
                address.Layers.ForEach(layer =>
                {
                    layer.Id = 0;
                    layer.Bins.ForEach(bin =>
                    {
                        bin.Id = 0;
                        bin.Products.ForEach(product =>
                        {
                            product.Id = 0;
                            var scenarioFound = scenarioChanges.FirstOrDefault(x => x.AddressIdDestiny == address.AddressId);
                            if (scenarioFound != null)
                            {
                                var foundProduct = products.FirstOrDefault(x => x.ProductId == scenarioFound.ProductId);
                                if (foundProduct != null)
                                {
                                    product.LocationX = 0;
                                    product.LocationY = 0;
                                    product.LocationZ = 0;
                                    product.PalletDepth = foundProduct.PalletDepth;
                                    product.PalletFront = foundProduct.PalletFront;
                                    product.PalletHeight = foundProduct.PalletHeight;

                                    product.TotalFront = foundProduct.TotalFront;
                                    product.TotalDepth = foundProduct.TotalDepth;
                                    product.TotalHeight = foundProduct.PalletHeight;
                                    product.ProductDescriptionLong = foundProduct.ProductDescription;
                                    product.ProductId = foundProduct.ProductId;
                                }
                                product.Images = new List<TPickingAddressImage>();
                                if (address.PositionType != "bin")
                                {
                                    product.Images.AddRange(new List<TPickingAddressImage>{
                                        new TPickingAddressImage{
                                            Filename = foundProduct.Images[3].Filename,
                                        },
                                        new TPickingAddressImage{
                                            Filename = foundProduct.Images[4].Filename,
                                        },
                                        new TPickingAddressImage{
                                            Filename = foundProduct.Images[5].Filename,
                                        }
                                    });
                                }
                                else
                                {
                                    product.Images.AddRange(new List<TPickingAddressImage>{
                                        new TPickingAddressImage{
                                            Filename = foundProduct.Images[0].Filename,
                                        },
                                        new TPickingAddressImage{
                                            Filename = foundProduct.Images[1].Filename,
                                        },
                                        new TPickingAddressImage{
                                            Filename = foundProduct.Images[2].Filename,
                                        }
                                    });
                                }
                            }
                            else
                            {

                                product.Images.ForEach(image =>
                                {
                                    image.Id = 0;
                                });
                            }
                        });
                    });
                });
            }

            _unitOfWork.Repository<TPickingAddressMaster>().AddRange(addresses.ToList());
            _unitOfWork.Repository<TScenarioChanges>().AddRange(scenarioChangesSave);


            var result = await _unitOfWork.Complete();
            if (result < 0)
                return false;
            return true;

        }

        public async Task<IReadOnlyList<ScenarioDto>> ListAllScenariosAsync()
        {
            var scenarios = await _unitOfWork.Repository<TScenarioMaster>().ListAsync(new ScenarioWithIncludesSpecification());


            var scenariosDto = new List<ScenarioDto>();
            foreach (var scenario in scenarios)
            {
                var criteriasDto = new List<ScenarioCriteriaDto>();
                foreach (var criteria in scenario.Criterias)
                {
                    criteriasDto.Add(new ScenarioCriteriaDto
                    {
                        CriteriaType = criteria.CriteriaType,
                        Id = criteria.Id,
                        ModifierType = criteria.ModifierType,
                        ModifierValue = criteria.ModifierValue,
                        PackagesGroup = criteria.PackagesGroup.Split(',').ToList(),
                        Product = criteria.Product.Split(',').ToList(),
                        ProductType = criteria.ProductType.Split(',').ToList(),
                    });
                }

                scenariosDto.Add(new ScenarioDto
                {
                    Criterias = criteriasDto,
                    Id = scenario.Id,
                    ScenarioName = scenario.ScenarioName,
                    Shifts = scenario.Shifts.Split(',').ToList(),
                    Timeframe = scenario.Timeframe
                });

            }

            return scenariosDto;
        }

        public async Task<IReadOnlyList<TScenarioChanges>> ListAllScenariosChangesAsync(string scenarioName)
        {
            return await _unitOfWork.Repository<TScenarioChanges>().ListAsync(new ScenarioChangesSpecification(scenarioName));
        }

        public async Task<bool> RemoveScenarioAsync(Guid id)
        {
            var foundScenario = await _unitOfWork.Repository<TScenarioMaster>().GetEntityWithSpecs(new ScenarioWithIncludesSpecification(id));
            if (foundScenario != null)
            {
                _unitOfWork.Repository<TScenarioMaster>().Delete(foundScenario);
                var addresses = await _unitOfWork.Repository<TPickingAddressMaster>().ListAsync(new AddressWithIncludes(foundScenario.ScenarioName));
                _unitOfWork.Repository<TPickingAddressMaster>().DeleteRange(addresses.ToList());


                var result = await _unitOfWork.Complete();
                if (result < 0)
                    return false;
                return true;
            }
            return false;
        }

        private List<ScenarioChangeORM> ReadJsonFile(string filename)
        {
            string json = File.ReadAllText(Path.Combine(Directory.GetCurrentDirectory(), "json", filename));
            return JsonConvert.DeserializeObject<List<ScenarioChangeORM>>(json);
        }
    }
}