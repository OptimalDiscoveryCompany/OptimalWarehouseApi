using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Core.Dtos.Scenario;
using Core.Entities;
using Core.Interfaces;
using Core.Interfaces.Services;
using Core.Specification.AddressSpecification;
using Core.Specification.ScenarioSpecification;

namespace Infrastructure.Services
{
    public class ScenarioService : IScenarioService
    {
        private readonly IUnitOfWork _unitOfWork;

        public ScenarioService(IUnitOfWork unitOfWork)
        {
            _unitOfWork = unitOfWork;
        }

        public async Task<bool> AddEditScenarioAsync(ScenarioDto scenarioDto)
        {
            var foundScenario = await _unitOfWork.Repository<TScenarioMaster>().GetEntityWithSpecs(new ScenarioWithIncludesSpecification(scenarioDto.Id));
            if (foundScenario != null)
            {
                _unitOfWork.Repository<TScenarioMaster>().Delete(foundScenario);
                await _unitOfWork.Complete();
            }

            var criterias = new List<TScenarioCriteria>();
            foreach (var criteria in scenarioDto.Criterias)
            {
                criterias.Add(new TScenarioCriteria
                {
                    CriteriaType = criteria.CriteriaType,
                    Id = criteria.Id,
                    ModifierType = criteria.ModifierType,
                    ModifierValue = criteria.ModifierValue,
                    PackagesGroup = string.Join(',', criteria.PackagesGroup),
                    Product = string.Join(',', criteria.Product),
                    ProductType = string.Join(',', criteria.ProductType),
                });
            }

            var scenario = new TScenarioMaster
            {
                Criterias = criterias,
                Id = scenarioDto.Id,
                ScenarioName = scenarioDto.ScenarioName,
                Shifts = string.Join(',', scenarioDto.Shifts),
                Timeframe = scenarioDto.Timeframe
            };

            _unitOfWork.Repository<TScenarioMaster>().Add(scenario);


            var addresses = await _unitOfWork.Repository<TPickingAddressMaster>().ListAsync(new AddressWithIncludes("Actual"));
            //create a copy of the actual area picking to create scenario and set ids to null
            foreach (var address in addresses)
            {
                address.PickingAreaDescription = scenarioDto.ScenarioName;
                address.Id = 0;
                address.Layers.ForEach(layer =>
                {
                    layer.Id = 0;
                    layer.Bins.ForEach(bin =>
                    {
                        bin.Id = 0;
                    });
                });
            }

            _unitOfWork.Repository<TPickingAddressMaster>().AddRange(addresses.ToList());

            var result = await _unitOfWork.Complete();
            if (result < 0)
                return false;
            return true;

        }

        public async Task<IReadOnlyList<ScenarioDto>> ListAllScenariosAsync()
        {
            var scenarios = await _unitOfWork.Repository<TScenarioMaster>().ListAsync(new ScenarioWithIncludesSpecification());


            var scenariosDto = new List<ScenarioDto>();
            foreach (var scenario in scenarios)
            {
                var criteriasDto = new List<ScenarioCriteriaDto>();
                foreach (var criteria in scenario.Criterias)
                {
                    criteriasDto.Add(new ScenarioCriteriaDto
                    {
                        CriteriaType = criteria.CriteriaType,
                        Id = criteria.Id,
                        ModifierType = criteria.ModifierType,
                        ModifierValue = criteria.ModifierValue,
                        PackagesGroup = criteria.PackagesGroup.Split(',').ToList(),
                        Product = criteria.Product.Split(',').ToList(),
                        ProductType = criteria.ProductType.Split(',').ToList(),
                    });
                }

                scenariosDto.Add(new ScenarioDto
                {
                    Criterias = criteriasDto,
                    Id = scenario.Id,
                    ScenarioName = scenario.ScenarioName,
                    Shifts = scenario.Shifts.Split(',').ToList(),
                    Timeframe = scenario.Timeframe
                });

            }

            return scenariosDto;
        }

        public async Task<IReadOnlyList<TScenarioChanges>> ListAllScenariosChangesAsync(string scenarioName)
        {
            return await _unitOfWork.Repository<TScenarioChanges>().ListAllAsync();
        }

        public async Task<bool> RemoveScenarioAsync(Guid id)
        {
            var foundScenario = await _unitOfWork.Repository<TScenarioMaster>().GetEntityWithSpecs(new ScenarioWithIncludesSpecification(id));
            if (foundScenario != null)
            {
                _unitOfWork.Repository<TScenarioMaster>().Delete(foundScenario);
                var result = await _unitOfWork.Complete();
                if (result < 0)
                    return false;
                return true;
            }
            return false;
        }
    }
}