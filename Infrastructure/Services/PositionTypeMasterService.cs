using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Core.Dtos.PositionType;
using Core.Entities;
using Core.Interfaces;
using Core.Interfaces.Services;
using Core.Specification.AddressSpecification;

namespace Infrastructure.Services
{
    public class PositionTypeMasterService : IPositionTypeMasterService
    {
        private readonly IUnitOfWork _unitOfWork;
        public PositionTypeMasterService(IUnitOfWork unitOfWork)
        {
            _unitOfWork = unitOfWork;
        }

        public async Task<bool> DeletePositionTypeAsync(int id)
        {
            var spec = new PositionTypeByIdWithIncludes(id);
            var entity = await _unitOfWork.Repository<TPickingPositionTypeMaster>().GetEntityWithSpecs(spec);
            _unitOfWork.Repository<TPickingPositionTypeMaster>().Delete(entity);

            var result = await _unitOfWork.Complete();

            if (result < 0)
                return false;
            return true;
        }

        public async Task<IReadOnlyList<PositionTypeMasterDto>> LoadAllData()
        {
            var items = await _unitOfWork.Repository<TPickingPositionTypeMaster>().ListAllAsync();

            var dtos = new List<PositionTypeMasterDto>();
            foreach (var item in items)
            {
                dtos.Add(new PositionTypeMasterDto
                {
                    Id = item.Id,
                    PositionColor = item.PositionColor,
                    PositionTypeDescription = item.PositionTypeDescription,
                    TotalDepth = item.TotalDepth,
                    TotalFront = item.TotalFront,
                    TotalHeight = item.TotalHeight,
                    Type = item.Type
                });
            }

            return dtos;
        }

        public async Task<PositionTypeMasterDto> LoadPositionTypeMasterByIdAsync(int id)
        {
            var spec = new PositionTypeByIdWithIncludes(id);
            var entity = await _unitOfWork.Repository<TPickingPositionTypeMaster>().GetEntityWithSpecs(spec);
            var positionTypeMasterDto = new PositionTypeMasterDto
            {
                Id = entity.Id,
                PositionColor = entity.PositionColor,
                PositionTypeDescription = entity.PositionTypeDescription,
                TotalDepth = entity.TotalDepth,
                TotalFront = entity.TotalFront,
                TotalHeight = entity.TotalHeight,
                Type = entity.Type
            };

            var layers = new List<PositionTypeLayerDto>();
            foreach (var layer in entity.Layers)
            {
                var nLayer = new PositionTypeLayerDto
                {
                    TotalHeight = layer.TotalHeight,
                    LayerDescription = layer.LayerDescription,
                    LocationX = layer.LocationX,
                    LocationY = layer.LocationY,
                    LocationZ = layer.LocationZ,
                    TotalDepth = layer.TotalDepth,
                    TotalFront = layer.TotalFront,
                };

                var bins = new List<PositionTypeBinDto>();
                foreach (var bin in layer.Bins)
                {
                    bins.Add(new PositionTypeBinDto
                    {
                        Angle = bin.Angle,
                        BinDescription = bin.BinDescription,
                        LocationX = bin.LocationX,
                        LocationY = bin.LocationY,
                        LocationZ = bin.LocationZ,
                        TotalDepth = bin.TotalDepth,
                        TotalFront = bin.TotalFront,
                        TotalHeight = bin.TotalHeight
                    });
                }
                nLayer.Bins = bins;
                layers.Add(nLayer);
            }

            positionTypeMasterDto.Layers = layers;
            return positionTypeMasterDto;
        }

        public async Task<bool> SavePositionTypeAsync(PositionTypeMasterDto typePositionRegisters)
        {
            var positionTypeMaster = new TPickingPositionTypeMaster()
            {
                Type = typePositionRegisters.Type,
                PositionTypeDescription = typePositionRegisters.PositionTypeDescription,
                TotalFront = typePositionRegisters.TotalFront,
                TotalDepth = typePositionRegisters.TotalDepth,
                TotalHeight = typePositionRegisters.TotalHeight,
                PositionColor = typePositionRegisters.PositionColor
            };

            if (typePositionRegisters.Layers.Count > 0)
            {

                positionTypeMaster.Layers = new List<TPickingPositionTypeLayers>();
                foreach (var pickingPositionTypeLayer in typePositionRegisters.Layers)
                {
                    var positionTypeLayer = new TPickingPositionTypeLayers();
                    positionTypeLayer.LayerDescription = pickingPositionTypeLayer.LayerDescription;
                    positionTypeLayer.LocationX = pickingPositionTypeLayer.LocationX;
                    positionTypeLayer.LocationY = pickingPositionTypeLayer.LocationY;
                    positionTypeLayer.LocationZ = pickingPositionTypeLayer.LocationZ;
                    positionTypeLayer.TotalDepth = pickingPositionTypeLayer.TotalDepth;
                    positionTypeLayer.TotalFront = pickingPositionTypeLayer.TotalFront;
                    positionTypeLayer.TotalHeight = pickingPositionTypeLayer.TotalHeight;







                    if (pickingPositionTypeLayer.Bins.Count > 0)
                    {

                        positionTypeLayer.Bins = new List<TPickingPositionTypeBins>();
                        foreach (var pickingPositionTypeBin in pickingPositionTypeLayer.Bins)
                        {
                            var positionTypeBin = new TPickingPositionTypeBins();
                            positionTypeBin.BinDescription = pickingPositionTypeBin.BinDescription;
                            positionTypeBin.TotalFront = pickingPositionTypeBin.TotalFront;
                            positionTypeBin.TotalHeight = pickingPositionTypeBin.TotalHeight;
                            positionTypeBin.TotalDepth = pickingPositionTypeBin.TotalDepth;
                            positionTypeBin.LocationX = pickingPositionTypeBin.LocationX;
                            positionTypeBin.LocationY = pickingPositionTypeBin.LocationY;
                            positionTypeBin.LocationZ = pickingPositionTypeBin.LocationZ;
                            positionTypeBin.Angle = pickingPositionTypeBin.Angle;

                            positionTypeLayer.Bins.Add(positionTypeBin);
                        }

                    }

                    positionTypeMaster.Layers.Add(positionTypeLayer);
                }
            }

            _unitOfWork.Repository<TPickingPositionTypeMaster>().Add(positionTypeMaster);
            var resultMaster = await _unitOfWork.Complete();
            if (resultMaster < 0)
                return false;

            return true;

        }

        public async Task<bool> UpdatePositionTypeAsync(int id, PositionTypeMasterDto positionTypeMaster)
        {
            var res = await DeletePositionTypeAsync(id);
            if (!res)
                return false;
            res = await SavePositionTypeAsync(positionTypeMaster);
            return res;
        }
    }
}