using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Core.Dtos.PositionType;
using Core.Entities;
using Core.Interfaces;
using Core.Interfaces.Services;

namespace Infrastructure.Services
{
    public class PositionTypeMasterService : IPositionTypeMasterService
    {
        private readonly IUnitOfWork _unitOfWork;
        public PositionTypeMasterService(IUnitOfWork unitOfWork)
        {
            _unitOfWork = unitOfWork;
        }

        public async Task<bool> DeletePositionTypeAsync(int id)
        {
            var entity = await _unitOfWork.Repository<TPickingPositionTypeMaster>().GetByIdAsync(id);
            _unitOfWork.Repository<TPickingPositionTypeMaster>().Delete(entity);

            var result = await _unitOfWork.Complete();

            if (result < 0)
                return false;
            return true;
        }

        public async Task<IReadOnlyList<PositionTypeMasterDto>> LoadAllData()
        {
            var items = await _unitOfWork.Repository<TPickingPositionTypeMaster>().ListAllAsync();

            var dtos = new List<PositionTypeMasterDto>();
            foreach (var item in items)
            {
                dtos.Add(new PositionTypeMasterDto
                {
                    Id = item.Id,
                    PositionColor = item.PositionColor,
                    PositionTypeDescription = item.PositionTypeDescription,
                    TotalDepth = item.TotalDepth,
                    TotalFront = item.TotalFront,
                    TotalHeight = item.TotalHeight,
                    Type = item.Type
                });
            }

            return dtos;
        }

        public async Task<bool> SavePositionTypeAsync(PositionTypeMasterDto typePositionRegisters)
        {
            var positionTypeMaster = new TPickingPositionTypeMaster()
            {
                Type = typePositionRegisters.Type,
                PositionTypeDescription = typePositionRegisters.PositionTypeDescription,
                TotalFront = typePositionRegisters.TotalFront,
                TotalDepth = typePositionRegisters.TotalDepth,
                TotalHeight = typePositionRegisters.TotalHeight,
                PositionColor = typePositionRegisters.PositionColor
            };

            _unitOfWork.Repository<TPickingPositionTypeMaster>().Add(positionTypeMaster);

            var resultMaster = await _unitOfWork.Complete();
            if (resultMaster < 0)
                return false;

            if (typePositionRegisters.Layers.Count > 0)
            {
                
                
                foreach (var pickingPositionTypeLayer in typePositionRegisters.Layers)
                {
                    var positionTypeLayer = new TPickingPositionTypeLayers();
                    positionTypeLayer.LayerDescription = pickingPositionTypeLayer.LayerDescription;
                    positionTypeLayer.PositionTypeMasterId = positionTypeMaster.Id; //Id do TypeMaster
                    positionTypeLayer.LocationX = pickingPositionTypeLayer.LocationX;
                    positionTypeLayer.LocationY = pickingPositionTypeLayer.LocationY;
                    positionTypeLayer.LocationZ = pickingPositionTypeLayer.LocationZ;
                    positionTypeLayer.TotalDepth = pickingPositionTypeLayer.TotalDepth;
                    positionTypeLayer.TotalFront = pickingPositionTypeLayer.TotalFront;
                    positionTypeLayer.TotalHeight = pickingPositionTypeLayer.TotalHeight;


                    _unitOfWork.Repository<TPickingPositionTypeLayers>().Add(positionTypeLayer);

                    var resultLayer = await _unitOfWork.Complete();
                    if (resultLayer < 0)
                        return false;


                    if (pickingPositionTypeLayer.Bins.Count > 0)
                    {
                        var positionTypeBinsList = new List<TPickingPositionTypeBins>();
                        foreach (var pickingPositionTypeBin in pickingPositionTypeLayer.Bins)
                        {
                            var positionTypeBin = new TPickingPositionTypeBins();
                            positionTypeBin.BinDescription = pickingPositionTypeBin.BinDescription;
                            positionTypeBin.PositionTypeLayerId = positionTypeLayer.Id; //Id do TypeLayer
                            positionTypeBin.TotalFront = pickingPositionTypeBin.TotalFront;
                            positionTypeBin.TotalHeight = pickingPositionTypeBin.TotalHeight;
                            positionTypeBin.TotalDepth = pickingPositionTypeBin.TotalDepth;
                            positionTypeBin.LocationX = pickingPositionTypeBin.LocationX;
                            positionTypeBin.LocationY = pickingPositionTypeBin.LocationY;
                            positionTypeBin.LocationZ = pickingPositionTypeBin.LocationZ;
                            positionTypeBin.Angle = pickingPositionTypeBin.Angle;

                            positionTypeBinsList.Add(positionTypeBin);
                        }

                        _unitOfWork.Repository<TPickingPositionTypeBins>().AddRange(positionTypeBinsList);

                        var resultBin = await _unitOfWork.Complete();
                        if (resultBin < 0)
                            return false;
                    }
                }
            }

            return true;

        }
    }
}