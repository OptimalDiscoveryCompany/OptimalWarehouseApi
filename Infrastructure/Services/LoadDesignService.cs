using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Core.Dtos.LoadDesign;
using Core.Entities;
using Core.Interfaces;
using Core.Interfaces.Services;
using Core.Specification.LoadDesignSpecification;

namespace Infrastructure.Services
{
    public class LoadDesignService : ILoadDesignService
    {
        private readonly IUnitOfWork _unitOfWork;

        public LoadDesignService(IUnitOfWork unitOfWork)
        {
            _unitOfWork = unitOfWork;
        }


        public async Task<IReadOnlyList<LoadDesignDto>> ListAllByDeliveryDateAsync(DateTime deliveryDate)
        {
            var specs = new LoadDesignByDeliveryDate(deliveryDate);
            var loadMasterList = await _unitOfWork.Repository<TLoadMaster>().ListAsync(specs);

            var loadDesignList = new List<LoadDesignDto>();

            foreach (var item in loadMasterList)
            {

                var layerPickerTotal = (item.PalletsLayerPickerOnly ?? 0) + (item.PalletsLayerPickerMixed ?? 0);
                var palletsTotal = (item.PalletsFull ?? 0) + (item.PalletsMixed ?? 0);
                var weight = (item.WeightLeft ?? 0.0f) + (item.WeightRight ?? 0.0f);


                var loadDesign = new LoadDesignDto
                {
                    BayComplexity = item.ComplexityScore ?? 0.0f,
                    CasesLayerPicker = item.CasesLayerPicker ?? 0.0f,
                    CasesPhysical = item.CasesPhysical ?? 0.0f,
                    CasesPhysicalMixed = item.CasesPhysicalMixed ?? 0.0f,
                    Group = "",
                    Interchanges = 0,
                    LoadStatus = item.LoadStatus,
                    NumberOfCustomers = item.NumberOfCustomers ?? 0,
                    PalletLayerPickerTotal = layerPickerTotal,
                    PalletsLayerPickerMixed = item.PalletsLayerPickerMixed ?? 0,
                    PalletsLayerPickerOnly = item.PalletsLayerPickerOnly ?? 0,
                    PalletsContainer = item.PalletsContainer ?? 0,
                    PalletsTotal = palletsTotal,
                    PalletsFull = item.PalletsFull ?? 0,
                    PalletsMixed = item.PalletsMixed ?? 0,
                    RouteId = item.LoadId,
                    TotalCube = item.TotalCube ?? 0.0f,
                    TripNumber = item.TripNumber,
                    Type = item.LocationId,
                    UserReviewed = item.UserReviewed ?? 0,
                    UtilizationCube = item.UtilizationCube ?? 0.0f,
                    VehicleBays = item.VehicleBays ?? 0,
                    VehicleId = string.IsNullOrEmpty(item.VehicleId) ? item.VehicleIdSubstitute : item.VehicleId,
                    Weight = weight
                };

                loadDesignList.Add(loadDesign);
            }

            return loadDesignList;

        }
    }
}