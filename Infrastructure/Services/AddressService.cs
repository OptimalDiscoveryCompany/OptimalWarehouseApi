using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Core.DefaultClass;
using Core.Dtos.Address;
using Core.Entities;
using Core.Interfaces;
using Core.Interfaces.Services;
using Core.Specification.AddressSpecification;
using Dapper;
using Infrastructure.Data;
using Microsoft.EntityFrameworkCore;

namespace Infrastructure.Services
{
    public class AddressService : IAddressService
    {
        private readonly IUnitOfWork _unitOfWork;
        private readonly StoreContext _storeContext;
        public AddressService(IUnitOfWork unitOfWork, StoreContext storeContext)
        {
            _unitOfWork = unitOfWork;
            _storeContext = storeContext;
        }

        public async Task<bool> AddAddressDetailAsync(int id, AddressDetailDto addressDetailDto)
        {

            var spec = new AddressByIdWithIncludes(id);
            var address = await _unitOfWork.Repository<TPickingAddressMaster>().GetEntityWithSpecs(spec);

            address.AddressId = addressDetailDto.AddressId;

            var binsDto = addressDetailDto.Layers.SelectMany(x => x.Bins).OrderBy(x => x.Id).ToList();
            var bins = address.Layers.SelectMany(x => x.Bins).OrderBy(x => x.Id).ToList();


            var conn = _storeContext.Database.GetDbConnection();

            await conn.OpenAsync();

            for (int i = 0; i < bins.Count; i++)
            {
                var bin = bins[i];
                var binDto = binsDto[i];
                bin.Products = new List<TPickingAddressProduct>();
                var productDto = binDto.Products.FirstOrDefault();

                await conn.ExecuteAsync("DELETE T_PICKING_ADDRESS_PRODUCT WHERE T_PICKING_ADDRESS_BIN_ID = @Id", new { Id = bin.Id });

                if (productDto != null)
                {
                    var images = new List<TPickingAddressImage>
                    {
                        new TPickingAddressImage
                        {
                            Filename = address.PositionType != "bin" ? $"/COMBINED/PF/{productDto.ProductId}.jpg" : $"/{productDto.ProductId}F.jpg",
                            Height = 200,
                            Width = 200
                        },
                        new TPickingAddressImage
                        {
                            Filename = address.PositionType != "bin" ? $"/COMBINED/PF/{productDto.ProductId}.jpg" : $"/{productDto.ProductId}F.jpg",
                            Height = 200,
                            Width = 200
                        },
                        new TPickingAddressImage
                        {
                            Filename = address.PositionType != "bin" ? $"/COMBINED/PL/{productDto.ProductId}.jpg" : $"/{productDto.ProductId}L.jpg",
                            Height = 200,
                            Width = 200
                        },
                        new TPickingAddressImage
                        {
                            Filename = address.PositionType != "bin" ? $"/COMBINED/PL/{productDto.ProductId}.jpg" : $"/{productDto.ProductId}L.jpg",
                            Height = 200,
                            Width = 200
                        },
                        new TPickingAddressImage
                        {
                            Filename = address.PositionType != "bin" ? $"/COMBINED/PT/{productDto.ProductId}.jpg" : $"/{productDto.ProductId}S.jpg",
                            Height = 200,
                            Width = 200
                        },
                        new TPickingAddressImage
                        {
                            Filename = address.PositionType != "bin" ? $"/COMBINED/PT/{productDto.ProductId}.jpg" : $"/{productDto.ProductId}S.jpg",
                            Height = 200,
                            Width = 200
                        },
                    };
                    bin.Products.Add(new TPickingAddressProduct
                    {
                        Images = images,
                        LocationX = 0,
                        LocationY = 0,
                        LocationZ = 0,
                        PalletDepth = productDto.PalletDepth,
                        PalletFront = productDto.PalletFront,
                        PalletHeight = productDto.PalletHeight,
                        ProductDescriptionLong = productDto.ProductDescription,
                        ProductId = productDto.ProductId,
                        TotalDepth = productDto.TotalDepth,
                        TotalFront = productDto.TotalFront,
                        TotalHeight = productDto.TotalHeight,
                    });
                }
            }

            _unitOfWork.Repository<TPickingAddressMaster>().Update(address);
            var res = await _unitOfWork.Complete();

            await conn.CloseAsync();

            if (res < 0)
                return false;

            return true;
        }

        public async Task<AddressDetailDto> GetAddressAsync(int id)
        {
            var spec = new AddressByIdWithIncludes(id);
            var address = await _unitOfWork.Repository<TPickingAddressMaster>().GetEntityWithSpecs(spec);
            if (address is null)
                return null;

            var addressDetailDto = new AddressDetailDto
            {
                AddressId = address.AddressId,
                Id = address.Id,
                TotalDepth = address.TotalDepth.Value,
                TotalFront = address.TotalFront.Value,
                TotalHeight = address.TotalHeight.Value,
                Type = address.PositionType,
                Layers = new List<LayerDto>()
            };


            var layers = new List<LayerDto>();
            foreach (var layer in address.Layers)
            {
                var nLayer = new LayerDto
                {
                    Id = layer.Id,
                    LayerDescription = layer.LayerDescription,
                };

                var bins = new List<BinDto>();

                foreach (var bin in layer.Bins)
                {
                    var nBin = new BinDto
                    {
                        Id = bin.Id,
                        BinDescription = bin.BinDescription,
                        Products = new List<ProductBinDto>()
                    };

                    var products = new List<ProductBinDto>();

                    foreach (var prod in bin.Products)
                    {
                        var images = new List<AddressImage3D>();

                        foreach (var image in prod.Images)
                        {
                            images.Add(new AddressImage3D
                            {
                                Filename = image.Filename,
                                Height = image.Height,
                                Width = image.Width
                            });
                        }

                        products.Add(new ProductBinDto
                        {
                            Id = prod.Id,
                            PalletDepth = prod.PalletDepth,
                            PalletFront = prod.PalletFront,
                            PalletHeight = prod.PalletHeight,
                            ProductDescription = prod.ProductDescriptionLong,
                            ProductId = prod.ProductId,
                            TotalDepth = prod.TotalDepth,
                            TotalFront = prod.TotalFront,
                            TotalHeight = prod.TotalHeight,
                            Images = images

                        });

                    }
                    nBin.Products = products;
                    bins.Add(nBin);
                }
                nLayer.Bins = bins;
                layers.Add(nLayer);
            }

            addressDetailDto.Layers = layers;
            return addressDetailDto;
        }

        public async Task<IReadOnlyList<Address3D>> ListAllAddress3DAsync()
        {
            var spec = new AddressWithIncludes();
            var addresses = await _unitOfWork.Repository<TPickingAddressMaster>().ListAsync(spec);


            var address3dList = new List<Address3D>();
            foreach (var address in addresses)
            {
                var address3d = new Address3D
                {
                    AddressId = address.AddressId,
                    Id = address.Id,
                    LocationX = address.LocationX.Value,
                    LocationY = address.LocationY.Value,
                    PickingAccess = (int)address.PickingAccess,
                    PickingAccessIsAccessable = address.PickingAccessIsAccessable,
                    PositionTypeDescription = address.PickingAreaDescription,
                    PositionType = address.PositionType,
                    TotalDepth = address.TotalDepth.Value,
                    TotalFront = address.TotalFront.Value,
                    TotalHeight = address.TotalHeight.Value
                };
#if DEBUG
                address3d.HostName = "http://localhost:5003";
#endif

                var layers = new List<Layer3D>();
                foreach (var layer in address.Layers)
                {
                    var nLayer = new Layer3D
                    {
                        Angle = 0.0f,
                        LocationX = layer.LocationX,
                        LocationY = layer.LocationY,
                        LocationZ = layer.LocationZ,
                        TotalDepth = layer.TotalDepth,
                        TotalFront = layer.TotalFront,
                        TotalHeight = layer.TotalHeight
                    };


                    var bins = new List<Bin3D>();
                    foreach (var bin in layer.Bins)
                    {
                        var bin3D = new Bin3D
                        {
                            LocationX = bin.LocationX,
                            LocationY = bin.LocationZ,
                            LocationZ = bin.LocationZ,
                            TotalDepth = bin.TotalDepth,
                            TotalFront = bin.TotalFront,
                            TotalHeight = bin.TotalHeight
                        };

                        if (bin.Products.Count == 0)
                        {
                            bin3D.Products = new List<Product3D>
                            {
                                DefaultProduct.Product
                            };

                            bin3D.Images = new List<AddressImage3D>
                            {
                                DefaultImage.AddressImage,
                                DefaultImage.AddressImage,
                                DefaultImage.AddressImage,
                                DefaultImage.AddressImage,
                                DefaultImage.AddressImage,
                                DefaultImage.AddressImage,
                            };
                        }
                        else
                        {

                            bin3D.Products = new List<Product3D>();
                            foreach (var product in bin.Products)
                            {
                                bin3D.Products.Add(new Product3D
                                {
                                    LocationX = product.LocationX,
                                    LocationY = product.LocationY,
                                    LocationZ = product.LocationZ,
                                    PalletDepth = product.PalletDepth,
                                    PalletFront = product.PalletFront,
                                    PalletHeight = product.PalletHeight,
                                    ProductDescriptionLong = product.ProductDescriptionLong,
                                    ProductId = product.ProductId,
                                    TotalDepth = product.TotalDepth,
                                    TotalFront = product.TotalFront,
                                    TotalHeight = product.TotalHeight
                                });

                                bin3D.Images = new List<AddressImage3D>();
                                foreach (var image in product.Images)
                                {
                                    bin3D.Images.Add(new AddressImage3D
                                    {
                                        Filename = image.Filename,
                                        Height = image.Height,
                                        Width = image.Width,
                                    });
                                }
                            }
                        }



                        bins.Add(bin3D);
                    }
                    nLayer.Bins = bins;

                    layers.Add(nLayer);
                }

                address3d.Layers = layers;
                address3dList.Add(address3d);
            }



            return address3dList;
        }

        public async Task<IReadOnlyList<AddressDto>> ListAllAddressAsync()
        {
            var addresses = await _unitOfWork.Repository<TPickingAddressMaster>().ListAllAsync();
            List<AddressDto> addressesDto = new();
            foreach (var address in addresses)
            {
                addressesDto.Add(
                    new AddressDto
                    {
                        AddressId = address.AddressId,
                        Id = address.Id,
                        LocationX = address.LocationX,
                        LocationY = address.LocationY,
                        PickingAccess = address.PickingAccess,
                        Sequence = address.Sequence,
                        TotalDepth = address.TotalDepth,
                        TotalFront = address.TotalFront,
                        TotalHeight = address.TotalHeight,
                        PositionTypeDescription = address.PositionTypeDescription,
                        Color = address.Color,
                        PickingAccessIsAccessable = address.PickingAccessIsAccessable,
                        PositionType = address.PositionType
                    }
                );
            }

            return addressesDto;

        }

        public async Task<bool> RegisterAddressesAsync(List<AddressRegisterDto> addressesRegisters)
        {
            var addresses = await _unitOfWork.Repository<TPickingAddressMaster>().ListAllAsync();
            _unitOfWork.Repository<TPickingAddressMaster>().DeleteRange(addresses.ToList());
            var result = await _unitOfWork.Complete();
            if (result < 0)
                return false;
            foreach (var register in addressesRegisters)
            {
                TPickingAddressMaster newAddress = new TPickingAddressMaster
                {
                    AddressId = register.AddressId,
                    LocationId = "B028",
                    PickingAreaDescription = "Actual",
                    LocationX = register.LocationX,
                    LocationY = register.LocationY,
                    PickingAccess = register.PickingAccess,
                    PositionTypeDescription = register.PositionTypeDescription,
                    TotalFront = register.TotalFront,
                    TotalDepth = register.TotalDepth,
                    TotalHeight = register.TotalHeight,
                    Sequence = register.Sequence,
                    PickingAccessIsAccessable = register.PickingAccessIsAccessable,
                    Color = register.Color
                };


                var spec = new PositionTypeByTypeWithIncludes(register.PositionType);
                var positionType = await _unitOfWork.Repository<TPickingPositionTypeMaster>().GetEntityWithSpecs(spec);

                newAddress.PositionTypeDescription = positionType.PositionTypeDescription;
                newAddress.TotalFront = positionType.TotalFront;
                newAddress.TotalDepth = positionType.TotalDepth;
                newAddress.TotalHeight = positionType.TotalHeight;
                newAddress.PositionType = positionType.Type;


                var layers = new List<TPickingAddressLayer>();
                positionType.Layers.ForEach(layer =>
                {
                    var nLayer = new TPickingAddressLayer
                    {
                        LayerDescription = layer.LayerDescription,
                        LocationX = layer.LocationX,
                        LocationY = layer.LocationY,
                        LocationZ = layer.LocationZ,
                        TotalDepth = layer.TotalDepth,
                        TotalFront = layer.TotalFront,
                        TotalHeight = layer.TotalHeight,
                    };

                    var bins = new List<TPickingAddressBin>();
                    layer.Bins.ForEach(bin =>
                    {
                        bins.Add(new TPickingAddressBin
                        {
                            Angle = bin.Angle,
                            BinDescription = bin.BinDescription,
                            LocationX = bin.LocationX,
                            LocationY = bin.LocationY,
                            LocationZ = bin.LocationZ,
                            TotalDepth = bin.TotalDepth,
                            TotalFront = bin.TotalFront,
                            TotalHeight = bin.TotalHeight,
                        });
                    });

                    nLayer.Bins = bins;
                    layers.Add(nLayer);
                });
                newAddress.Layers = layers;
                _unitOfWork.Repository<TPickingAddressMaster>().Add(newAddress);

            }

            result = await _unitOfWork.Complete();
            if (result < 0)
                return false;
            return true;

        }

        public async Task<bool> RemoveAddressesAsync(List<AddressDto> addressesRemove)
        {
            var addresses = new List<TPickingAddressMaster>();
            foreach (var rem in addressesRemove)
            {
                var markToRemove = await _unitOfWork.Repository<TPickingAddressMaster>().GetByIdAsync(rem.Id);
                addresses.Add(markToRemove);
            }
            _unitOfWork.Repository<TPickingAddressMaster>().DeleteRange(addresses);
            var result = await _unitOfWork.Complete();
            if (result <= 0)
                return false;
            return true;


        }
    }
}