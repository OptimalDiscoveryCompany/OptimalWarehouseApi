using Core.Entities;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.AspNetCore.Http;
using System.Security.Claims;
using Microsoft.Data.SqlClient;
using Dapper;
using Microsoft.Extensions.Logging;

namespace Infrastructure.Data;

public partial class StoreContext : DbContext
{

    private readonly IConfiguration _configuration;
    private readonly HttpContext _httpContext;
    private readonly ILogger _logger;

    public virtual DbSet<TLoadMaster> TLoadMaster { get; set; }
    public virtual DbSet<TPickingPositionTypeMaster> TPickingPositionTypeMaster { get; set; }
    public virtual DbSet<TPickingPositionTypeLayers> TPickingPositionTypeLayer { get; set; }
    public virtual DbSet<TPickingPositionTypeBins> TPickingPositionTypeBin { get; set; }
    public virtual DbSet<TPickingAddressMaster> TPickingAddressMaster { get; set; }
    public virtual DbSet<TPickingAddressLayer> TPickingAddressLayer { get; set; }
    public virtual DbSet<TPickingAddressBin> TPickingAddressBin { get; set; }
    public virtual DbSet<TPickingAddressProduct> TPickingAddressProduct { get; set; }
    public virtual DbSet<TPickingAddressImage> TPickingAddressImage { get; set; }


    public StoreContext(
        DbContextOptions<StoreContext> options,
        IConfiguration configuration,
        IHttpContextAccessor _httpContextAccessor,
        ILogger<StoreContext> logger) : base(options)
    {
        _configuration = configuration;
        _httpContext = _httpContextAccessor.HttpContext;
        _logger = logger;
    }

    // protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    // {
    //     var locationIdString = _httpContext?.User?.Claims.FirstOrDefault(x => x.Type == ClaimTypes.UserData)?.Value; ;
    //     if (!string.IsNullOrEmpty(locationIdString))
    //     {
    //         using (var conn = new SqlConnection(_configuration.GetConnectionString("RPAuthTransactions")))
    //         {
    //             try
    //             {
    //                 conn.Open();
    //                 var query = @"SELECT ConnectionString  FROM Databases D 
    //                               INNER JOIN Locations L ON L.DatabaseId  = D.ID 
    //                               WHERE 
    //                                 L.Id  = @locationIdString
    //                             ";

    //                 var connectionString = conn.Query<string>(query, new { locationIdString }).FirstOrDefault();
    //                 optionsBuilder.UseSqlServer(_configuration.GetConnectionString(connectionString));
    //                 _logger.LogInformation($"Connection Selected is: {connectionString}");
    //             }
    //             catch (Exception ex)
    //             {
    //                 _logger.LogError($"Error on excute select: {ex}");
    //             }
    //             finally
    //             {
    //                 conn.Close();
    //             }
    //         }
    //     }
    // }

    partial void OnModelCreatingPartial(ModelBuilder modelBuilder);

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<TLoadMaster>(entity =>
            {
                entity.HasKey(e => e.Id)
                    .HasName("ID");

                entity.ToTable("T_LOAD_MASTER");

                entity.Property(e => e.BoxAssignment)
                    .HasColumnName("BOX_ASSIGNMENT")
                    .HasMaxLength(10);

                entity.Property(e => e.CasesConverted).HasColumnName("CASES_CONVERTED");

                entity.Property(e => e.CasesLayerPicker).HasColumnName("CASES_LAYER_PICKER");

                entity.Property(e => e.CasesPhysical).HasColumnName("CASES_PHYSICAL");

                entity.Property(e => e.CasesPhysicalMixed).HasColumnName("CASES_PHYSICAL_MIXED");

                entity.Property(e => e.ComplexityScore).HasColumnName("COMPLEXITY_SCORE");

                entity.Property(e => e.DeliveryDate)
                    .HasColumnName("DELIVERY_DATE")
                    .HasColumnType("datetime");

                entity.Property(e => e.LastPrinted)
                    .HasColumnName("LAST_PRINTED")
                    .HasColumnType("datetime");

                entity.Property(e => e.LoadId)
                    .HasColumnName("LOAD_ID")
                    .HasMaxLength(20);

                entity.Property(e => e.LoadStatus).HasColumnName("LOAD_STATUS");

                entity.Property(e => e.LoadingPriority).HasColumnName("LOADING_PRIORITY");

                entity.Property(e => e.LoadingSequence).HasColumnName("LOADING_SEQUENCE");

                entity.Property(e => e.LocationId)
                    .IsRequired()
                    .HasColumnName("LOCATION_ID")
                    .HasMaxLength(20);

                entity.Property(e => e.Notes)
                    .HasColumnName("NOTES")
                    .HasMaxLength(50);

                entity.Property(e => e.NumberOfCustomers).HasColumnName("NUMBER_OF_CUSTOMERS");

                entity.Property(e => e.OtherData)
                    .HasColumnName("OTHER_DATA")
                    .HasMaxLength(30);

                entity.Property(e => e.OtherData2)
                    .HasColumnName("OTHER_DATA_2")
                    .HasMaxLength(30);

                entity.Property(e => e.OtherNumeric).HasColumnName("OTHER_NUMERIC");

                entity.Property(e => e.PalletsColumns).HasColumnName("PALLETS_COLUMNS");

                entity.Property(e => e.PalletsContainer).HasColumnName("PALLETS_CONTAINER");

                entity.Property(e => e.PalletsFull).HasColumnName("PALLETS_FULL");

                entity.Property(e => e.PalletsLayerPickerMixed).HasColumnName("PALLETS_LAYER_PICKER_MIXED");

                entity.Property(e => e.PalletsLayerPickerOnly).HasColumnName("PALLETS_LAYER_PICKER_ONLY");

                entity.Property(e => e.PalletsMixed).HasColumnName("PALLETS_MIXED");

                entity.Property(e => e.PickingAreaId)
                    .HasColumnName("PICKING_AREA_ID")
                    .HasMaxLength(20);

                entity.Property(e => e.Region)
                    .HasColumnName("REGION")
                    .HasMaxLength(20);

                entity.Property(e => e.RouteId)
                    .HasColumnName("ROUTE_ID")
                    .HasMaxLength(20);

                entity.Property(e => e.TotalCube).HasColumnName("TOTAL_CUBE");

                entity.Property(e => e.TripNumber).HasColumnName("TRIP_NUMBER");

                entity.Property(e => e.UserReviewed).HasColumnName("USER_REVIEWED");

                entity.Property(e => e.UtilizationCube).HasColumnName("UTILIZATION_CUBE");

                entity.Property(e => e.UtilizationVolume).HasColumnName("UTILIZATION_VOLUME");

                entity.Property(e => e.UtilizationWeight).HasColumnName("UTILIZATION_WEIGHT");

                entity.Property(e => e.VehicleBays).HasColumnName("VEHICLE_BAYS");

                entity.Property(e => e.VehicleId)
                    .IsRequired()
                    .HasColumnName("VEHICLE_ID")
                    .HasMaxLength(20);

                entity.Property(e => e.VehicleIdSubstitute)
                    .HasColumnName("VEHICLE_ID_SUBSTITUTE")
                    .HasMaxLength(20);

                entity.Property(e => e.VehicleTagNumber)
                    .HasColumnName("VEHICLE_TAG_NUMBER")
                    .HasMaxLength(20);

                entity.Property(e => e.WeightLeft).HasColumnName("WEIGHT_LEFT");

                entity.Property(e => e.WeightRight).HasColumnName("WEIGHT_RIGHT");
            }
        );

        modelBuilder.Entity<TPickingPositionTypeMaster>(entity =>
        {
            entity.HasKey(e => e.Id).HasName("ID");

            entity.ToTable("T_PICKING_POSITION_TYPE_MASTER");

            entity.Property(e => e.PositionColor)
                .HasColumnName("POSITION_COLOR");

            entity.Property(e => e.PositionTypeDescription)
                .IsRequired()
                .HasColumnName("POSITION_TYPE_DESCRIPTION")
                .HasMaxLength(50);

            entity.Property(e => e.TotalDepth).HasColumnName("TOTAL_DEPTH");

            entity.Property(e => e.TotalFront).HasColumnName("TOTAL_FRONT");

            entity.Property(e => e.TotalHeight).HasColumnName("TOTAL_HEIGHT");

            entity.Property(e => e.Type).HasColumnName("TYPE");

        });

        modelBuilder.Entity<TPickingPositionTypeLayers>(entity =>
        {
            entity.HasKey(e => e.Id).HasName("ID");

            entity.ToTable("T_PICKING_POSITION_TYPE_LAYER");

            entity.Property(e => e.PositionTypeMasterId)
                .HasColumnName("T_POSITION_TYPE_MASTER_ID");

            entity.Property(e => e.LayerDescription)
                .HasColumnName("LAYER_DESCRIPTION")
                .HasMaxLength(50);

            entity.Property(e => e.TotalDepth).HasColumnName("TOTAL_DEPTH");

            entity.Property(e => e.TotalFront).HasColumnName("TOTAL_FRONT");

            entity.Property(e => e.TotalHeight).HasColumnName("TOTAL_HEIGHT");

            entity.Property(e => e.LocationX).HasColumnName("LOCATION_X");

            entity.Property(e => e.LocationY).HasColumnName("LOCATION_Y");

            entity.Property(e => e.LocationZ).HasColumnName("LOCATION_Z");


        });

        modelBuilder.Entity<TPickingPositionTypeBins>(entity =>
        {
            entity.HasKey(e => e.Id).HasName("ID");

            entity.ToTable("T_PICKING_POSITION_TYPE_BIN");

            entity.Property(e => e.PositionTypeLayerId)
                .HasColumnName("T_PICKING_POSITION_TYPE_LAYER_ID");

            entity.Property(e => e.BinDescription)
                .HasColumnName("BIN_DESCRIPTION")
                .HasMaxLength(50);

            entity.Property(e => e.TotalDepth).HasColumnName("TOTAL_DEPTH");

            entity.Property(e => e.TotalFront).HasColumnName("TOTAL_FRONT");

            entity.Property(e => e.TotalHeight).HasColumnName("TOTAL_HEIGHT");

            entity.Property(e => e.LocationX).HasColumnName("LOCATION_X");

            entity.Property(e => e.LocationY).HasColumnName("LOCATION_Y");

            entity.Property(e => e.LocationZ).HasColumnName("LOCATION_Z");

            entity.Property(e => e.Angle).HasColumnName("ANGLE");



        });

        modelBuilder.Entity<TPickingAddressMaster>(entity =>
       {
           entity.HasKey(e => e.Id)
               .HasName("ID");


           entity.ToTable("T_PICKING_ADDRESS_MASTER");

           entity.Property(e => e.AddressDisplay).HasColumnName("ADDRESS_DISPLAY");

           entity.Property(e => e.AddressId)
               .HasColumnName("ADDRESS_ID")
               .HasMaxLength(20);

           entity.Property(e => e.LocationId)
               .IsRequired()
               .HasColumnName("LOCATION_ID")
               .HasMaxLength(20);

           entity.Property(e => e.LocationX).HasColumnName("LOCATION_X");

           entity.Property(e => e.LocationY).HasColumnName("LOCATION_Y");

           entity.Property(e => e.LocationZ).HasColumnName("LOCATION_Z");

           entity.Property(e => e.ParentAddressId)
               .HasColumnName("PARENT_ADDRESS_ID")
               .HasMaxLength(20);

           entity.Property(e => e.PickingAccess).HasColumnName("PICKING_ACCESS");

           entity.Property(e => e.PickingAccessX).HasColumnName("PICKING_ACCESS_X");

           entity.Property(e => e.PickingAccessY).HasColumnName("PICKING_ACCESS_Y");

           entity.Property(e => e.PickingAreaDescription)
               .IsRequired()
               .HasColumnName("PICKING_AREA_DESCRIPTION")
               .HasMaxLength(20);

           entity.Property(e => e.PositionTypeDescription)
               .HasColumnName("POSITION_TYPE_DESCRIPTION")
               .HasMaxLength(50);

           entity.Property(e => e.PositionsX).HasColumnName("POSITIONS_X");

           entity.Property(e => e.PositionsY).HasColumnName("POSITIONS_Y");

           entity.Property(e => e.PositionsZ).HasColumnName("POSITIONS_Z");

           entity.Property(e => e.ProductId)
               .HasColumnName("PRODUCT_ID")
               .HasMaxLength(20);

           entity.Property(e => e.Quantity).HasColumnName("QUANTITY");

           entity.Property(e => e.ReplenishmentAccess).HasColumnName("REPLENISHMENT_ACCESS");

           entity.Property(e => e.ReplenishmentMethodId)
               .HasColumnName("REPLENISHMENT_METHOD_ID")
               .HasMaxLength(20);

           entity.Property(e => e.Rotation).HasColumnName("ROTATION");

           entity.Property(e => e.Sequence).HasColumnName("SEQUENCE");

           entity.Property(e => e.TotalDepth).HasColumnName("TOTAL_DEPTH");

           entity.Property(e => e.TotalFront).HasColumnName("TOTAL_FRONT");

           entity.Property(e => e.TotalHeight).HasColumnName("TOTAL_HEIGHT");

       });


        modelBuilder.Entity<TPickingAddressLayer>(entity =>
        {

            entity.HasKey(e => e.Id)
                .HasName("ID");

            entity.Property(e => e.TPickingAddressMasterId)
                .HasColumnName("T_PICKING_ADDRESS_MASTER_ID");

            entity.Property(e => e.LayerDescription)
                .HasColumnName("LAYER_DESCRIPTION")
                .HasMaxLength(255);

            entity.Property(e => e.TotalFront)
                .HasColumnName("TOTAL_FRONT");

            entity.Property(e => e.TotalDepth)
                .HasColumnName("TOTAL_DEPTH");

            entity.Property(e => e.TotalHeight)
                .HasColumnName("TOTAL_HEIGHT");

            entity.Property(e => e.LocationX)
                .HasColumnName("LOCATION_X");

            entity.Property(e => e.LocationY)
                .HasColumnName("LOCATION_Y");

            entity.Property(e => e.LocationZ)
                .HasColumnName("LOCATION_Z");

            entity.HasOne(e => e.TPickingAddressMaster)
                .WithMany(m => m.Layers)
                .HasForeignKey(e => e.TPickingAddressMasterId);

            entity.ToTable("T_PICKING_ADDRESS_LAYER");
        });



        modelBuilder.Entity<TPickingAddressBin>(entity =>
        {

            entity.HasKey(e => e.Id)
                .HasName("ID");

            entity.Property(e => e.TPickingAddressLayerId)
                .HasColumnName("T_PICKING_ADDRESS_LAYER_ID");

            entity.Property(e => e.BinDescription)
                .HasColumnName("BIN_DESCRIPTION")
                .HasMaxLength(255);

            entity.Property(e => e.TotalFront)
                .HasColumnName("TOTAL_FRONT");

            entity.Property(e => e.TotalDepth)
                .HasColumnName("TOTAL_DEPTH");

            entity.Property(e => e.TotalHeight)
                .HasColumnName("TOTAL_HEIGHT");

            entity.Property(e => e.LocationX)
                .HasColumnName("LOCATION_X");

            entity.Property(e => e.LocationY)
                .HasColumnName("LOCATION_Y");

            entity.Property(e => e.LocationZ)
                .HasColumnName("LOCATION_Z");

            entity.Property(e => e.Angle)
                .HasColumnName("ANGLE");


            entity.HasOne(e => e.TPickingAddressLayer)
                .WithMany(l => l.Bins)
                .HasForeignKey(e => e.TPickingAddressLayerId);

            entity.ToTable("T_PICKING_ADDRESS_BIN");


        });


        modelBuilder.Entity<TPickingAddressProduct>(entity =>
        {

            entity.HasKey(e => e.Id)
                .HasName("ID");

            entity.Property(e => e.TPickingAddressBinId)
                .HasColumnName("T_PICKING_ADDRESS_BIN_ID");

            entity.Property(e => e.ProductId)
                .HasColumnName("PRODUCT_ID")
                .HasMaxLength(255);

            entity.Property(e => e.ProductDescriptionLong)
                .HasColumnName("PRODUCT_DESCRIPTION_LONG")
                .HasMaxLength(255);

            entity.Property(e => e.TotalFront)
                .HasColumnName("TOTAL_FRONT");

            entity.Property(e => e.TotalDepth)
                .HasColumnName("TOTAL_DEPTH");

            entity.Property(e => e.TotalHeight)
                .HasColumnName("TOTAL_HEIGHT");

            entity.Property(e => e.LocationX)
                .HasColumnName("LOCATION_X");

            entity.Property(e => e.LocationY)
                .HasColumnName("LOCATION_Y");

            entity.Property(e => e.LocationZ)
                .HasColumnName("LOCATION_Z");

            entity.Property(e => e.PalletFront)
                .HasColumnName("PALLET_FRONT");

            entity.Property(e => e.PalletDepth)
                .HasColumnName("PALLET_DEPTH");

            entity.Property(e => e.PalletHeight)
                .HasColumnName("PALLET_HEIGHT");


            entity.HasOne(e => e.TPickingAddressBin)
                .WithMany(b => b.Products)
                .HasForeignKey(e => e.TPickingAddressBinId);


            entity.ToTable("T_PICKING_ADDRESS_PRODUCT");
        });


        modelBuilder.Entity<TPickingAddressImage>(entity =>
        {
            entity.HasKey(e => e.Id)
                .HasName("ID");

            entity.Property(e => e.TPickingAddressProductId)
                .HasColumnName("T_PICKING_ADDRESS_PRODUCT_ID");

            entity.Property(e => e.Width)
                .HasColumnName("WIDTH");

            entity.Property(e => e.Height)
                .HasColumnName("Height");

            entity.Property(e => e.Filename)
                .HasColumnName("FILENAME")
                .HasMaxLength(255);


            entity.HasOne(e => e.TPickingAddressProduct)
                .WithMany(p => p.Images)
                .HasForeignKey(e => e.TPickingAddressProductId);


            entity.ToTable("T_PICKING_ADDRESS_IMAGE");
        });




        OnModelCreatingPartial(modelBuilder);
    }
}
