using Core.Entities;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.AspNetCore.Http;
using System.Security.Claims;
using Microsoft.Data.SqlClient;
using Dapper;
using Microsoft.Extensions.Logging;

namespace Infrastructure.Data;

public partial class StoreContext : DbContext
{

    private readonly IConfiguration _configuration;
    private readonly HttpContext _httpContext;
    private readonly ILogger _logger;

    public DbSet<TLoadMaster> TLoadMaster { get; set; }
    public virtual DbSet<TPickingPositionTypeMaster> TPickingPositionTypeMaster { get; set; }
    public StoreContext(DbContextOptions<StoreContext> options, IConfiguration configuration, IHttpContextAccessor _httpContextAccessor, ILogger<StoreContext> logger) : base(options)
    {
        _configuration = configuration;
        _httpContext = _httpContextAccessor.HttpContext;
        _logger = logger;
    }

    // protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    // {
    //     var locationIdString = _httpContext?.User?.Claims.FirstOrDefault(x => x.Type == ClaimTypes.UserData)?.Value; ;
    //     if (!string.IsNullOrEmpty(locationIdString))
    //     {
    //         using (var conn = new SqlConnection(_configuration.GetConnectionString("RPAuthTransactions")))
    //         {
    //             try
    //             {
    //                 conn.Open();
    //                 var query = @"SELECT ConnectionString  FROM Databases D 
    //                               INNER JOIN Locations L ON L.DatabaseId  = D.ID 
    //                               WHERE 
    //                                 L.Id  = @locationIdString
    //                             ";

    //                 var connectionString = conn.Query<string>(query, new { locationIdString }).FirstOrDefault();
    //                 optionsBuilder.UseSqlServer(_configuration.GetConnectionString(connectionString));
    //                 _logger.LogInformation($"Connection Selected is: {connectionString}");
    //             }
    //             catch (Exception ex)
    //             {
    //                 _logger.LogError($"Error on excute select: {ex}");
    //             }
    //             finally
    //             {
    //                 conn.Close();
    //             }
    //         }
    //     }
    // }

    partial void OnModelCreatingPartial(ModelBuilder modelBuilder);

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<TLoadMaster>(entity =>
            {
                entity.HasKey(e => e.Id)
                    .HasName("ID");

                entity.ToTable("T_LOAD_MASTER");

                entity.Property(e => e.BoxAssignment)
                    .HasColumnName("BOX_ASSIGNMENT")
                    .HasMaxLength(10);

                entity.Property(e => e.CasesConverted).HasColumnName("CASES_CONVERTED");

                entity.Property(e => e.CasesLayerPicker).HasColumnName("CASES_LAYER_PICKER");

                entity.Property(e => e.CasesPhysical).HasColumnName("CASES_PHYSICAL");

                entity.Property(e => e.CasesPhysicalMixed).HasColumnName("CASES_PHYSICAL_MIXED");

                entity.Property(e => e.ComplexityScore).HasColumnName("COMPLEXITY_SCORE");

                entity.Property(e => e.DeliveryDate)
                    .HasColumnName("DELIVERY_DATE")
                    .HasColumnType("datetime");

                entity.Property(e => e.LastPrinted)
                    .HasColumnName("LAST_PRINTED")
                    .HasColumnType("datetime");

                entity.Property(e => e.LoadId)
                    .HasColumnName("LOAD_ID")
                    .HasMaxLength(20);

                entity.Property(e => e.LoadStatus).HasColumnName("LOAD_STATUS");

                entity.Property(e => e.LoadingPriority).HasColumnName("LOADING_PRIORITY");

                entity.Property(e => e.LoadingSequence).HasColumnName("LOADING_SEQUENCE");

                entity.Property(e => e.LocationId)
                    .IsRequired()
                    .HasColumnName("LOCATION_ID")
                    .HasMaxLength(20);

                entity.Property(e => e.Notes)
                    .HasColumnName("NOTES")
                    .HasMaxLength(50);

                entity.Property(e => e.NumberOfCustomers).HasColumnName("NUMBER_OF_CUSTOMERS");

                entity.Property(e => e.OtherData)
                    .HasColumnName("OTHER_DATA")
                    .HasMaxLength(30);

                entity.Property(e => e.OtherData2)
                    .HasColumnName("OTHER_DATA_2")
                    .HasMaxLength(30);

                entity.Property(e => e.OtherNumeric).HasColumnName("OTHER_NUMERIC");

                entity.Property(e => e.PalletsColumns).HasColumnName("PALLETS_COLUMNS");

                entity.Property(e => e.PalletsContainer).HasColumnName("PALLETS_CONTAINER");

                entity.Property(e => e.PalletsFull).HasColumnName("PALLETS_FULL");

                entity.Property(e => e.PalletsLayerPickerMixed).HasColumnName("PALLETS_LAYER_PICKER_MIXED");

                entity.Property(e => e.PalletsLayerPickerOnly).HasColumnName("PALLETS_LAYER_PICKER_ONLY");

                entity.Property(e => e.PalletsMixed).HasColumnName("PALLETS_MIXED");

                entity.Property(e => e.PickingAreaId)
                    .HasColumnName("PICKING_AREA_ID")
                    .HasMaxLength(20);

                entity.Property(e => e.Region)
                    .HasColumnName("REGION")
                    .HasMaxLength(20);

                entity.Property(e => e.RouteId)
                    .HasColumnName("ROUTE_ID")
                    .HasMaxLength(20);

                entity.Property(e => e.TotalCube).HasColumnName("TOTAL_CUBE");

                entity.Property(e => e.TripNumber).HasColumnName("TRIP_NUMBER");

                entity.Property(e => e.UserReviewed).HasColumnName("USER_REVIEWED");

                entity.Property(e => e.UtilizationCube).HasColumnName("UTILIZATION_CUBE");

                entity.Property(e => e.UtilizationVolume).HasColumnName("UTILIZATION_VOLUME");

                entity.Property(e => e.UtilizationWeight).HasColumnName("UTILIZATION_WEIGHT");

                entity.Property(e => e.VehicleBays).HasColumnName("VEHICLE_BAYS");

                entity.Property(e => e.VehicleId)
                    .IsRequired()
                    .HasColumnName("VEHICLE_ID")
                    .HasMaxLength(20);

                entity.Property(e => e.VehicleIdSubstitute)
                    .HasColumnName("VEHICLE_ID_SUBSTITUTE")
                    .HasMaxLength(20);

                entity.Property(e => e.VehicleTagNumber)
                    .HasColumnName("VEHICLE_TAG_NUMBER")
                    .HasMaxLength(20);

                entity.Property(e => e.WeightLeft).HasColumnName("WEIGHT_LEFT");

                entity.Property(e => e.WeightRight).HasColumnName("WEIGHT_RIGHT");
            }
        );

        modelBuilder.Entity<TPickingPositionTypeMaster>(entity =>
            {
                entity.HasKey(e => e.Id).HasName("ID");

                entity.ToTable("T_PICKING_POSITION_TYPE_MASTER");

                entity.Property(e => e.BinSeparation).HasColumnName("BIN_SEPARATION");

                entity.Property(e => e.HorizontalPositions).HasColumnName("HORIZONTAL_POSITIONS");

                entity.Property(e => e.LayerPicker).HasColumnName("LAYER_PICKER");

                entity.Property(e => e.PositionColor)
                    .HasColumnName("POSITION_COLOR");

                entity.Property(e => e.PositionTypeDescription)
                    .IsRequired()
                    .HasColumnName("POSITION_TYPE_DESCRIPTION")
                    .HasMaxLength(50);

                entity.Property(e => e.TotalDepth).HasColumnName("TOTAL_DEPTH");

                entity.Property(e => e.TotalFront).HasColumnName("TOTAL_FRONT");

                entity.Property(e => e.TotalHeight).HasColumnName("TOTAL_HEIGHT");

                entity.Property(e => e.VerticalPositions).HasColumnName("VERTICAL_POSITIONS");
            });


        OnModelCreatingPartial(modelBuilder);
    }
}
